<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAST EBox Storage Calculator | BaseConfig</title>
    <meta name="description" content="VAST Data EBox on Cisco UCS Storage Calculator - Plan storage capacity, pricing, and infrastructure requirements for VAST EBox deployments.">
    <link rel="canonical" href="https://baseconfig.tech/tools/storage-calculator/">
    
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/logo.jpg">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brand: {
                            50: '#ecfeff',
                            100: '#cffafe',
                            200: '#a5f3fc',
                            300: '#67e8f9',
                            400: '#22d3ee',
                            500: '#06b6d4',
                            600: '#0891b2',
                            700: '#0e7490',
                            800: '#155e75',
                            900: '#164e63',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
        }
        .gradient-text {
            background: linear-gradient(135deg, #22d3ee 0%, #06b6d4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .card {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.5);
        }
        .input-field {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.5);
        }
        .input-field:focus {
            outline: none;
            border-color: #22d3ee;
            box-shadow: 0 0 0 2px rgba(34, 211, 238, 0.2);
        }
        .capacity-row {
            background-color: rgba(34, 197, 94, 0.1);
        }
        .price-row {
            background-color: rgba(251, 146, 60, 0.1);
        }
        .networking-row {
            background-color: rgba(59, 130, 246, 0.1);
        }
        .total-row {
            background-color: rgba(148, 163, 184, 0.2);
        }
        .rack-unit {
            height: 20px;
            border: 1px solid rgba(71, 85, 105, 0.5);
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .rack-server {
            background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%);
        }
        .rack-switch-fe {
            background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%);
        }
        .rack-switch-be {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        }
        .rack-empty {
            background: rgba(30, 41, 59, 0.5);
        }
        .network-node {
            border: 2px solid;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 11px;
            text-align: center;
        }
        .network-line {
            stroke-width: 2;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        .cursor-blink {
            animation: blink 1s infinite;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen font-sans text-gray-100">
    <!-- Navigation -->
    <nav class="fixed top-0 left-0 right-0 z-50 bg-slate-900/80 backdrop-blur-md border-b border-slate-700/50">
        <div class="max-w-6xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <a href="/" class="flex items-center gap-2 font-mono font-bold text-cyan-400">
                    <span class="text-lg">&gt;BASE CONFIG</span><span class="cursor-blink">_</span>
                </a>
                <div class="flex items-center gap-4">
                    <a href="/tools/infra-planner/" class="text-gray-300 hover:text-cyan-400 transition-colors text-sm">Infrastructure Planner</a>
                    <a href="/" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition-colors">
                        ← Back to Home
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Setup Wizard Modal -->
    <div id="wizardOverlay" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
        <div class="card rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold mb-2">VAST EBox Storage Configuration</h2>
                    <p class="text-gray-400">Let's configure your storage solution step by step</p>
                    <div class="flex justify-center gap-2 mt-4">
                        <div id="wizardDot1" class="w-3 h-3 rounded-full bg-cyan-500"></div>
                        <div id="wizardDot2" class="w-3 h-3 rounded-full bg-slate-600"></div>
                        <div id="wizardDot3" class="w-3 h-3 rounded-full bg-slate-600"></div>
                        <div id="wizardDot4" class="w-3 h-3 rounded-full bg-slate-600"></div>
                    </div>
                </div>

                <!-- Step 1: Capacity -->
                <div id="wizardStep1" class="wizard-step space-y-6">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <i data-lucide="hard-drive" class="w-5 h-5 text-cyan-400"></i>Step 1: Capacity Requirements
                    </h3>
                    
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">How much storage do you need?</label>
                        <div class="flex gap-2">
                            <input type="number" id="wizardCapacity" value="10" min="1" class="input-field flex-1 px-4 py-3 rounded-lg text-white text-lg">
                            <select id="wizardCapacityUnit" class="input-field px-4 py-3 rounded-lg text-white">
                                <option value="TB">TB</option>
                                <option value="PB" selected>PB</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Capacity Type</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button type="button" onclick="selectWizardCapacityType('usable')" id="wizardCapUsable" class="wizard-cap-btn p-4 rounded-lg border-2 border-cyan-500 bg-cyan-900/30 text-left">
                                <div class="font-semibold">Usable</div>
                                <div class="text-xs text-gray-400">After VAST data protection</div>
                            </button>
                            <button type="button" onclick="selectWizardCapacityType('raw')" id="wizardCapRaw" class="wizard-cap-btn p-4 rounded-lg border-2 border-slate-600 hover:border-slate-500 text-left">
                                <div class="font-semibold">Raw</div>
                                <div class="text-xs text-gray-400">Total drive capacity</div>
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Drive Option</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button type="button" onclick="selectWizardDriveOption(0)" id="wizardDrive15" class="wizard-drive-btn p-3 rounded-lg border-2 border-slate-600 hover:border-cyan-500 text-center">
                                <div class="font-semibold text-cyan-400">15.3TB</div>
                                <div class="text-xs text-gray-400">100TB/server</div>
                            </button>
                            <button type="button" onclick="selectWizardDriveOption(1)" id="wizardDrive30" class="wizard-drive-btn p-3 rounded-lg border-2 border-purple-500 bg-purple-900/30 text-center">
                                <div class="font-semibold text-purple-400">30.7TB</div>
                                <div class="text-xs text-gray-400">200TB/server</div>
                            </button>
                            <button type="button" onclick="selectWizardDriveOption(2)" id="wizardDrive61" class="wizard-drive-btn p-3 rounded-lg border-2 border-slate-600 hover:border-green-500 text-center">
                                <div class="font-semibold text-green-400">61.4TB</div>
                                <div class="text-xs text-gray-400">350TB/server</div>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-slate-800/50 rounded-lg">
                        <div class="text-sm text-gray-400">Quick sizing estimate:</div>
                        <div id="wizardSizingPreview" class="text-purple-400 font-medium mt-1">~50 EBox servers (30.7TB drives)</div>
                    </div>
                </div>

                <!-- Step 2: Network Design -->
                <div id="wizardStep2" class="wizard-step hidden space-y-6">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <i data-lucide="network" class="w-5 h-5 text-green-400"></i>Step 2: Network Design
                    </h3>
                    
                    <p class="text-gray-400 text-sm">VAST EBox requires separate frontend (client) and backend (cluster) networks. Choose how to implement this:</p>
                    
                    <div class="space-y-3">
                        <button type="button" onclick="selectWizardNetworkDesign('dedicated')" id="wizardNetDedicated" class="wizard-net-btn w-full p-4 rounded-lg border-2 border-green-500 bg-green-900/30 text-left">
                            <div class="flex items-center gap-3">
                                <i data-lucide="git-branch" class="w-6 h-6 text-green-400"></i>
                                <div>
                                    <div class="font-semibold">Dedicated Networks</div>
                                    <div class="text-xs text-gray-400">Separate switch pairs for frontend and backend</div>
                                </div>
                            </div>
                            <div class="mt-3 p-3 bg-slate-800/50 rounded text-xs text-gray-400">
                                <div class="grid grid-cols-2 gap-2">
                                    <div>✓ Maximum isolation</div>
                                    <div>✓ Full bandwidth per network</div>
                                    <div>✓ Independent scaling</div>
                                    <div>• More switches required</div>
                                </div>
                            </div>
                        </button>
                        
                        <button type="button" onclick="selectWizardNetworkDesign('unified')" id="wizardNetUnified" class="wizard-net-btn w-full p-4 rounded-lg border-2 border-slate-600 hover:border-yellow-500 text-left">
                            <div class="flex items-center gap-3">
                                <i data-lucide="combine" class="w-6 h-6 text-yellow-400"></i>
                                <div>
                                    <div class="font-semibold">Unified Network</div>
                                    <div class="text-xs text-gray-400">Single ToR pair only - no spine layer support</div>
                                </div>
                            </div>
                            <div class="mt-3 p-3 bg-slate-800/50 rounded text-xs text-gray-400">
                                <div class="grid grid-cols-2 gap-2">
                                    <div>✓ Fewer switches</div>
                                    <div>✓ Lower cost</div>
                                    <div>✓ Simpler cabling</div>
                                    <div>• Shared bandwidth</div>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Connection Type -->
                <div id="wizardStep3" class="wizard-step hidden space-y-6">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <i data-lucide="cable" class="w-5 h-5 text-purple-400"></i>Step 3: Connection Type
                    </h3>
                    
                    <p class="text-gray-400 text-sm">Each EBox server has 2× ConnectX-7 NICs with 2×200G ports each. Choose how to connect to the 400G switches:</p>
                    
                    <div class="space-y-3">
                        <button type="button" onclick="selectWizardConnectionType('direct')" id="wizardConnDirect" class="wizard-conn-btn w-full p-4 rounded-lg border-2 border-purple-500 bg-purple-900/30 text-left">
                            <div class="flex items-center gap-3">
                                <i data-lucide="plug" class="w-6 h-6 text-purple-400"></i>
                                <div>
                                    <div class="font-semibold">Direct 200G</div>
                                    <div class="text-xs text-gray-400">Native 200G connections to switch ports</div>
                                </div>
                            </div>
                            <div class="mt-3 p-3 bg-slate-800/50 rounded text-xs">
                                <div class="text-gray-300">Server (2×200G) → Switch (200G ports)</div>
                                <div class="text-gray-500 mt-1">Uses more switch ports, simpler cabling</div>
                            </div>
                        </button>
                        
                        <button type="button" onclick="selectWizardConnectionType('breakout')" id="wizardConnBreakout" class="wizard-conn-btn w-full p-4 rounded-lg border-2 border-slate-600 hover:border-cyan-500 text-left">
                            <div class="flex items-center gap-3">
                                <i data-lucide="split" class="w-6 h-6 text-cyan-400"></i>
                                <div>
                                    <div class="font-semibold">Breakout 400G → 2×200G</div>
                                    <div class="text-xs text-gray-400">Use breakout cables from 400G switch ports</div>
                                </div>
                            </div>
                            <div class="mt-3 p-3 bg-slate-800/50 rounded text-xs">
                                <div class="text-gray-300">Server (2×200G) → Breakout → Switch (400G port)</div>
                                <div class="text-gray-500 mt-1">Uses fewer switch ports, requires breakout cables</div>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Step 4: Rack Layout -->
                <div id="wizardStep4" class="wizard-step hidden space-y-6">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <i data-lucide="layout-grid" class="w-5 h-5 text-yellow-400"></i>Step 4: Rack Layout
                    </h3>
                    
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Rack Power Budget (kW)</label>
                        <div class="flex gap-2 mb-2">
                            <button type="button" onclick="setWizardRackPower(10)" class="wizard-power-btn px-3 py-2 rounded bg-slate-700 hover:bg-slate-600 text-sm">10 kW</button>
                            <button type="button" onclick="setWizardRackPower(15)" class="wizard-power-btn px-3 py-2 rounded bg-slate-700 hover:bg-slate-600 text-sm">15 kW</button>
                            <button type="button" onclick="setWizardRackPower(20)" class="wizard-power-btn px-3 py-2 rounded bg-cyan-600 text-sm">20 kW</button>
                            <button type="button" onclick="setWizardRackPower(25)" class="wizard-power-btn px-3 py-2 rounded bg-slate-700 hover:bg-slate-600 text-sm">25 kW</button>
                        </div>
                        <input type="number" id="wizardRackPower" value="20" min="5" max="50" class="input-field w-full px-4 py-3 rounded-lg text-white" onchange="updateWizardRackPreview()">
                    </div>
                    
                    <div class="space-y-3">
                        <button type="button" onclick="selectWizardRackLayout('single')" id="wizardLayoutSingle" class="wizard-layout-btn w-full p-4 rounded-lg border-2 border-cyan-500 bg-cyan-900/30 text-left">
                            <div class="flex items-center gap-3">
                                <i data-lucide="square" class="w-6 h-6 text-cyan-400"></i>
                                <div>
                                    <div class="font-semibold">Single Rack</div>
                                    <div class="text-xs text-gray-400" id="wizardSingleDesc">All switches + servers in one rack</div>
                                </div>
                            </div>
                        </button>
                        
                        <button type="button" onclick="selectWizardRackLayout('split')" id="wizardLayoutSplit" class="wizard-layout-btn w-full p-4 rounded-lg border-2 border-slate-600 hover:border-purple-500 text-left">
                            <div class="flex items-center gap-3">
                                <i data-lucide="columns" class="w-6 h-6 text-purple-400"></i>
                                <div>
                                    <div class="font-semibold">Split (2 Racks)</div>
                                    <div class="text-xs text-gray-400">Fewer switches per rack = more power for servers</div>
                                </div>
                            </div>
                        </button>
                    </div>
                    
                    <div id="wizardRackPreview" class="p-4 bg-slate-800/50 rounded-lg text-sm"></div>
                </div>

                <!-- Navigation Buttons -->
                <div class="flex justify-between mt-8 pt-6 border-t border-slate-600">
                    <button id="wizardBack" onclick="wizardPrevStep()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium transition-colors hidden">
                        <span class="flex items-center gap-2"><i data-lucide="arrow-left" class="w-4 h-4"></i>Back</span>
                    </button>
                    <div class="flex-1"></div>
                    <button id="wizardNext" onclick="wizardNextStep()" class="px-6 py-3 bg-cyan-500 hover:bg-cyan-600 rounded-lg font-medium transition-colors">
                        <span class="flex items-center gap-2">Next<i data-lucide="arrow-right" class="w-4 h-4"></i></span>
                    </button>
                    <button id="wizardFinish" onclick="finishWizard()" class="px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-medium transition-colors hidden">
                        <span class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4"></i>View Results</span>
                    </button>
                </div>
                
                <div class="text-center mt-4">
                    <button onclick="skipWizard()" class="text-sm text-gray-500 hover:text-gray-300">Skip wizard and use defaults</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-7xl pt-24">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold mb-2">
                <span class="text-cyan-500">&gt;</span> VAST Data EBox on Cisco UCS <span class="gradient-text">Storage Calculator</span>
            </h1>
            <p class="text-gray-400">Calculate storage capacity, pricing, and infrastructure requirements for VAST EBox deployments</p>
            <p class="text-xs text-gray-500 mt-2">* Pricing reflects standard conservative discounts</p>
            <button onclick="showWizard()" class="mt-4 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm inline-flex items-center gap-2">
                <i data-lucide="wand-2" class="w-4 h-4"></i>Re-run Configuration Wizard
            </button>
        </header>

        <!-- Input Controls -->
        <div class="card rounded-xl p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Capacity -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <i data-lucide="hard-drive" class="w-5 h-5 text-cyan-400"></i>
                        Capacity Requirements
                    </h3>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Target Capacity</label>
                        <div class="flex gap-2">
                            <input type="number" id="capacity" value="0" min="0" step="0.01" class="input-field flex-1 px-4 py-2 rounded-lg text-white">
                            <select id="capacity-unit" class="input-field px-3 py-2 rounded-lg text-white">
                                <option value="TB">TB</option>
                                <option value="PB">PB</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Capacity Type</label>
                        <select id="capacity-type" class="input-field w-full px-4 py-2 rounded-lg text-white">
                            <option value="usable">Usable</option>
                            <option value="raw">Raw</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Drive Option</label>
                        <select id="drive-option" class="input-field w-full px-4 py-2 rounded-lg text-white">
                            <option value="0">15.3TB (100TB usable/server)</option>
                            <option value="1" selected>30.7TB (200TB usable/server)</option>
                            <option value="2">61.4TB (350TB usable/server)</option>
                        </select>
                    </div>
                </div>

                <!-- Network Design -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <i data-lucide="network" class="w-5 h-5 text-green-400"></i>
                        Network Design
                    </h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button type="button" id="netDesignDedicated" onclick="selectNetworkDesign('dedicated')" class="net-design-btn p-3 rounded-lg border-2 border-green-500 bg-green-900/30 transition-all text-left">
                            <div class="flex items-center gap-2 mb-1">
                                <i data-lucide="git-branch" class="w-4 h-4 text-green-400"></i>
                                <span class="font-semibold text-sm">Dedicated</span>
                            </div>
                            <div class="text-xs text-gray-400">Separate FE/BE switches</div>
                        </button>
                        <button type="button" id="netDesignUnified" onclick="selectNetworkDesign('unified')" class="net-design-btn p-3 rounded-lg border-2 border-slate-600 hover:border-yellow-500 transition-all text-left">
                            <div class="flex items-center gap-2 mb-1">
                                <i data-lucide="combine" class="w-4 h-4 text-yellow-400"></i>
                                <span class="font-semibold text-sm">Unified</span>
                            </div>
                            <div class="text-xs text-gray-400">Single ToR pair only (no spine)</div>
                        </button>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Connection Type</label>
                        <select id="connectionType" class="input-field w-full px-3 py-2 rounded-lg text-white text-sm" onchange="updateVisualizations()">
                            <option value="direct">Direct 200G (2×200G per NIC)</option>
                            <option value="breakout">Breakout 400G→2×200G</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Leaf Switch Type</label>
                        <select id="switchType" class="input-field w-full px-3 py-2 rounded-lg text-white text-sm" onchange="updateVisualizations()">
                            <option value="32port">32-port 400G (1U)</option>
                            <option value="64port">64-port 400G (2U)</option>
                        </select>
                    </div>
                    <div id="network-design-description" class="text-xs text-gray-400 p-2 bg-slate-800/30 rounded">
                        Dedicated: Separate frontend and backend switch pairs. Maximum isolation and bandwidth.
                    </div>
                    <div id="port-density-warning" class="hidden text-xs p-2 bg-red-900/30 border border-red-500/50 rounded">
                    </div>
                </div>

                <!-- Rack Layout -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <i data-lucide="layout-grid" class="w-5 h-5 text-purple-400"></i>
                        Rack Layout
                    </h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button type="button" id="layoutSingle" onclick="selectRackLayout('single')" class="rack-layout-btn p-3 rounded-lg border-2 border-cyan-500 bg-cyan-900/30 transition-all text-left">
                            <div class="flex items-center gap-2 mb-1">
                                <i data-lucide="square" class="w-4 h-4 text-cyan-400"></i>
                                <span class="font-semibold text-sm">Single Rack</span>
                            </div>
                            <div class="text-xs text-gray-400" id="singleRackSwitchCount">4 switches in 1 rack</div>
                        </button>
                        <button type="button" id="layoutSplit" onclick="selectRackLayout('split')" class="rack-layout-btn p-3 rounded-lg border-2 border-slate-600 hover:border-purple-500 transition-all text-left">
                            <div class="flex items-center gap-2 mb-1">
                                <i data-lucide="columns" class="w-4 h-4 text-purple-400"></i>
                                <span class="font-semibold text-sm">Split (2 Racks)</span>
                            </div>
                            <div class="text-xs text-gray-400">More servers per rack</div>
                        </button>
                    </div>
                    <div id="layout-description" class="text-xs text-gray-400 p-2 bg-slate-800/30 rounded">
                        Single rack: 4 switches (2 FE + 2 BE) + servers in one rack. More compact but power-limited.
                    </div>
                </div>
            </div>
        </div>

        <!-- Sizing Results -->
        <div class="card rounded-xl p-6 mb-8">
            <h3 class="text-lg font-semibold flex items-center gap-2 mb-4">
                <i data-lucide="calculator" class="w-5 h-5 text-cyan-400"></i>
                Sizing Summary
            </h3>
            <div id="sizing-results" class="p-4 bg-slate-800/50 rounded-lg text-sm text-gray-300">
                Enter capacity to see the number of servers and racks required (minimum 8 servers per cluster).
            </div>
        </div>

        <!-- Power & Rack Configuration -->
        <div class="card rounded-xl p-6 mb-8">
            <h3 class="text-lg font-semibold flex items-center gap-2 mb-4">
                <i data-lucide="zap" class="w-5 h-5 text-yellow-400"></i>
                Power Configuration
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Rack Power Budget (kW)</label>
                    <input type="number" id="rack-power" value="20" min="5" max="50" step="0.5" class="input-field w-full px-4 py-2 rounded-lg text-white">
                </div>
                <div class="md:col-span-2">
                    <div id="power-summary" class="p-4 bg-slate-800/50 rounded-lg text-sm"></div>
                </div>
            </div>
        </div>

        <!-- Deployment Scale Summary -->
        <div class="card rounded-xl p-6 mb-8 border-2 border-cyan-500/30">
            <h3 class="text-lg font-semibold flex items-center gap-2 mb-4">
                <i data-lucide="layout-grid" class="w-5 h-5 text-cyan-400"></i>
                Deployment Scale
            </h3>
            <div id="deployment-scale-summary" class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Rack Layout Visualization -->
        <div class="card rounded-xl p-6 mb-8">
            <h3 class="text-lg font-semibold flex items-center gap-2 mb-4">
                <i data-lucide="server" class="w-5 h-5 text-cyan-400"></i>
                Rack Layout Visualization
                <span id="rack-viz-drive-label" class="text-sm font-normal text-purple-400 ml-2">(30.7TB drives)</span>
            </h3>
            <p class="text-xs text-gray-500 mb-4">Showing 1 scalable unit (representative sample of full deployment)</p>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <div id="rack-viz-selected" class="bg-slate-900 rounded-lg p-2"></div>
                    <div id="rack-info-selected" class="mt-2 text-xs text-gray-400 text-center"></div>
                </div>
                <div class="space-y-4">
                    <div class="p-4 bg-slate-800/50 rounded-lg">
                        <h4 class="text-sm font-medium text-gray-300 mb-3">Configuration Summary</h4>
                        <div id="rack-config-summary" class="text-sm space-y-2"></div>
                    </div>
                </div>
            </div>
            <div class="mt-4 flex flex-wrap gap-4 justify-center text-xs">
                <div class="flex items-center gap-2"><div class="w-4 h-4 rack-server rounded"></div><span>EBox Server (1U)</span></div>
                <div class="flex items-center gap-2"><div class="w-4 h-4 rack-switch-fe rounded"></div><span>Frontend Switch (1U)</span></div>
                <div class="flex items-center gap-2"><div class="w-4 h-4 rack-switch-be rounded"></div><span>Backend Switch (1U)</span></div>
                <div class="flex items-center gap-2"><div class="w-4 h-4 rack-empty rounded border border-slate-600"></div><span>Empty</span></div>
            </div>
        </div>

        <!-- Network Topology -->
        <div class="card rounded-xl p-6 mb-8">
            <h3 class="text-lg font-semibold flex items-center gap-2 mb-4">
                <i data-lucide="network" class="w-5 h-5 text-purple-400"></i>
                Dual-Network Topology (Frontend + Backend)
            </h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <h4 class="text-sm font-medium text-purple-400 mb-3">Frontend Network (Client Access)</h4>
                    <div class="p-4 bg-slate-800/50 rounded-lg">
                        <div class="text-xs text-gray-400 mb-2">ConnectX-7 NIC #1 → Frontend Leaf Switches → Spine → Clients</div>
                        <div id="frontend-network-info" class="text-sm"></div>
                    </div>
                </div>
                <div>
                    <h4 class="text-sm font-medium text-green-400 mb-3">Backend Network (Storage Cluster)</h4>
                    <div class="p-4 bg-slate-800/50 rounded-lg">
                        <div class="text-xs text-gray-400 mb-2">ConnectX-7 NIC #2 → Backend Leaf Switches → Cluster Traffic</div>
                        <div id="backend-network-info" class="text-sm"></div>
                    </div>
                </div>
            </div>
            <div class="mt-6">
                <h4 class="text-sm font-medium text-gray-300 mb-3">Network Architecture Diagram</h4>
                <div id="network-diagram" class="bg-slate-900 rounded-lg p-4 overflow-x-auto"></div>
            </div>
            <div class="mt-4 p-4 bg-slate-800/30 rounded-lg">
                <h4 class="text-sm font-medium text-gray-300 mb-2">EBox Server Network Configuration</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs text-gray-400">
                    <div>
                        <div class="font-medium text-cyan-400 mb-1">ConnectX-7 NIC #1 (Frontend)</div>
                        <ul class="list-disc list-inside space-y-1">
                            <li>2x 200G ports (400G total bandwidth)</li>
                            <li>Connected to Frontend Leaf switches</li>
                            <li>Handles client I/O traffic</li>
                        </ul>
                    </div>
                    <div>
                        <div class="font-medium text-green-400 mb-1">ConnectX-7 NIC #2 (Backend)</div>
                        <ul class="list-disc list-inside space-y-1">
                            <li>2x 200G ports (400G total bandwidth)</li>
                            <li>Connected to Backend Leaf switches</li>
                            <li>Handles cluster replication & rebuild</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comparison Table -->
        <div class="card rounded-xl overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm" id="bomTable">
                    <thead>
                        <tr class="bg-slate-800">
                            <th class="text-left py-4 px-4 text-gray-300 font-semibold">Component</th>
                            <th class="text-center py-4 px-4 text-cyan-400 font-semibold">15.3TB Drive Option</th>
                            <th class="text-center py-4 px-4 text-purple-400 font-semibold">30.7TB Drive Option</th>
                            <th class="text-center py-4 px-4 text-green-400 font-semibold">61.4TB Drive Option</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="border-b border-slate-700">
                            <td class="py-3 px-4 text-gray-300">Drive Configuration</td>
                            <td class="py-3 px-4 text-center">8 × 15.3TB + 2 × 960GB</td>
                            <td class="py-3 px-4 text-center">8 × 30.7TB + 2 × 1.92TB</td>
                            <td class="py-3 px-4 text-center">7 × 61.4TB + 3 × 1.92TB</td>
                        </tr>
                        <tr class="capacity-row border-b border-slate-700">
                            <td class="py-3 px-4 text-gray-300">Raw Capacity per Server (TB)</td>
                            <td class="py-3 px-4 text-center raw-capacity">122.40</td>
                            <td class="py-3 px-4 text-center raw-capacity">249.44</td>
                            <td class="py-3 px-4 text-center raw-capacity">428.84</td>
                        </tr>
                        <tr class="capacity-row border-b border-slate-700">
                            <td class="py-3 px-4 text-gray-300">Usable Capacity per Server (TB)</td>
                            <td class="py-3 px-4 text-center usable-capacity">100.00</td>
                            <td class="py-3 px-4 text-center usable-capacity">200.00</td>
                            <td class="py-3 px-4 text-center usable-capacity">370.00</td>
                        </tr>
                        <tr class="capacity-row border-b border-slate-700">
                            <td class="py-3 px-4 text-gray-300">Servers Required (min. 8)</td>
                            <td class="py-3 px-4 text-center servers-required font-semibold">12</td>
                            <td class="py-3 px-4 text-center servers-required font-semibold">12</td>
                            <td class="py-3 px-4 text-center servers-required font-semibold">12</td>
                        </tr>
                        <tr class="capacity-row border-b border-slate-700">
                            <td class="py-3 px-4 text-gray-300">Racks Required</td>
                            <td class="py-3 px-4 text-center racks-required">1</td>
                            <td class="py-3 px-4 text-center racks-required">1</td>
                            <td class="py-3 px-4 text-center racks-required">1</td>
                        </tr>
                        <tr class="capacity-row border-b border-slate-700">
                            <td class="py-3 px-4 text-gray-300">Total Rack Units (U)</td>
                            <td class="py-3 px-4 text-center total-rack-units">14</td>
                            <td class="py-3 px-4 text-center total-rack-units">14</td>
                            <td class="py-3 px-4 text-center total-rack-units">14</td>
                        </tr>
                        <tr class="networking-row border-b border-slate-700">
                            <td class="py-3 px-4 text-gray-300">Network Switches (2 per rack)</td>
                            <td class="py-3 px-4 text-center network-switches">2</td>
                            <td class="py-3 px-4 text-center network-switches">2</td>
                            <td class="py-3 px-4 text-center network-switches">2</td>
                        </tr>
                        <tr class="networking-row border-b border-slate-700">
                            <td class="py-3 px-4 text-gray-300">Server Optics (2 per server)</td>
                            <td class="py-3 px-4 text-center optics-count">24</td>
                            <td class="py-3 px-4 text-center optics-count">24</td>
                            <td class="py-3 px-4 text-center optics-count">24</td>
                        </tr>
                        <tr class="networking-row border-b border-slate-700">
                            <td class="py-3 px-4 text-gray-300">Leaf-Spine Optics (4 per switch)</td>
                            <td class="py-3 px-4 text-center spine-optics-count">8</td>
                            <td class="py-3 px-4 text-center spine-optics-count">8</td>
                            <td class="py-3 px-4 text-center spine-optics-count">8</td>
                        </tr>
                        <tr class="total-row border-b border-slate-700">
                            <td class="py-3 px-4 text-gray-300 font-semibold">Total Solution Price ($)</td>
                            <td class="py-3 px-4 text-center total-solution-price font-semibold text-cyan-400">3,033,988.10</td>
                            <td class="py-3 px-4 text-center total-solution-price font-semibold text-purple-400">4,085,026.10</td>
                            <td class="py-3 px-4 text-center total-solution-price font-semibold text-green-400">5,865,694.10</td>
                        </tr>
                        <tr class="price-row border-b border-slate-700">
                            <td class="py-3 px-4 text-gray-300">Price per Usable TB ($/TB)</td>
                            <td class="py-3 px-4 text-center price-per-usable-tb">2,528.32</td>
                            <td class="py-3 px-4 text-center price-per-usable-tb">1,702.09</td>
                            <td class="py-3 px-4 text-center price-per-usable-tb">1,319.03</td>
                        </tr>
                        <tr class="total-row">
                            <td class="py-3 px-4 text-gray-300 font-semibold">Cost Breakdown ($)</td>
                            <td class="py-3 px-4 text-center cost-breakdown text-xs">Servers: 937,785.00<br>Drives: 1,806,570.00<br>Network: 275,161.10<br>Optics: 14,472.00</td>
                            <td class="py-3 px-4 text-center cost-breakdown text-xs">Servers: 937,785.00<br>Drives: 2,857,608.00<br>Network: 275,161.10<br>Optics: 14,472.00</td>
                            <td class="py-3 px-4 text-center cost-breakdown text-xs">Servers: 937,785.00<br>Drives: 4,638,276.00<br>Network: 275,161.10<br>Optics: 14,472.00</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-8 text-center text-gray-500 text-sm">
            <p>Prepared by Dan Stacks | <a href="/" class="text-cyan-400 hover:text-cyan-300">BaseConfig</a></p>
        </footer>
    </div>

    <script>
        lucide.createIcons();

        // Wizard state
        let wizardStep = 1;
        let wizardCapacityType = 'usable';
        let wizardDriveOption = 1; // Default to 30.7TB (index 1)
        let wizardNetworkDesign = 'dedicated';
        let wizardConnectionType = 'direct';
        let wizardRackLayout = 'single';

        // State
        let selectedRackLayout = 'single';
        let selectedNetworkDesign = 'dedicated';

        // Wizard functions
        function updateWizardStep() {
            // Hide all steps
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`wizardStep${i}`).classList.add('hidden');
                document.getElementById(`wizardDot${i}`).classList.remove('bg-cyan-500');
                document.getElementById(`wizardDot${i}`).classList.add('bg-slate-600');
            }
            // Show current step
            document.getElementById(`wizardStep${wizardStep}`).classList.remove('hidden');
            // Update dots
            for (let i = 1; i <= wizardStep; i++) {
                document.getElementById(`wizardDot${i}`).classList.remove('bg-slate-600');
                document.getElementById(`wizardDot${i}`).classList.add('bg-cyan-500');
            }
            // Update buttons
            document.getElementById('wizardBack').classList.toggle('hidden', wizardStep === 1);
            document.getElementById('wizardNext').classList.toggle('hidden', wizardStep === 4);
            document.getElementById('wizardFinish').classList.toggle('hidden', wizardStep !== 4);
            
            lucide.createIcons();
        }

        function wizardNextStep() {
            if (wizardStep < 4) {
                wizardStep++;
                updateWizardStep();
                if (wizardStep === 2) updateWizardNetworkOptions();
                if (wizardStep === 4) updateWizardRackPreview();
            }
        }
        
        function updateWizardNetworkOptions() {
            // Calculate if unified is available based on servers needed
            const servers = window.wizardServersNeeded || 8;
            const rackPower = 20; // Default rack power for estimation
            const switchPower = 638;
            const serverPower = 900;
            
            // Calculate max servers per scalable unit for single rack layout
            // Unified: 2 switches, Dedicated: 4 switches
            const unifiedSwitches = 2;
            const unifiedSwitchPower = unifiedSwitches * switchPower / 1000;
            const unifiedAvailPower = rackPower - unifiedSwitchPower;
            const unifiedMaxServers = Math.min(Math.floor(unifiedAvailPower * 1000 / serverPower), 42 - unifiedSwitches);
            
            // For split layout, unified can handle 2 racks worth
            const unifiedMaxServersSplit = unifiedMaxServers * 2;
            
            // Unified is only valid if servers fit in single ToR pair
            const unifiedValid = servers <= unifiedMaxServersSplit;
            
            const unifiedBtn = document.getElementById('wizardNetUnified');
            if (!unifiedValid) {
                unifiedBtn.disabled = true;
                unifiedBtn.classList.add('opacity-50', 'cursor-not-allowed');
                unifiedBtn.classList.remove('hover:border-yellow-500');
                // Update the button content to show why it's disabled
                unifiedBtn.innerHTML = `
                    <div class="flex items-center gap-3">
                        <i data-lucide="combine" class="w-6 h-6 text-gray-500"></i>
                        <div>
                            <div class="font-semibold text-gray-500">Unified Network</div>
                            <div class="text-xs text-gray-500">Single ToR pair only - no spine layer support</div>
                        </div>
                    </div>
                    <div class="mt-3 p-3 bg-red-900/20 border border-red-500/30 rounded text-xs">
                        <div class="text-red-400 font-medium">Not available for this configuration</div>
                        <div class="text-gray-400 mt-1">${servers} servers requires spine layer (max ${unifiedMaxServersSplit} for unified)</div>
                    </div>
                `;
                // If unified was selected, switch to dedicated
                if (wizardNetworkDesign === 'unified') {
                    selectWizardNetworkDesign('dedicated');
                }
            } else {
                unifiedBtn.disabled = false;
                unifiedBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                unifiedBtn.classList.add('hover:border-yellow-500');
                unifiedBtn.innerHTML = `
                    <div class="flex items-center gap-3">
                        <i data-lucide="combine" class="w-6 h-6 text-yellow-400"></i>
                        <div>
                            <div class="font-semibold">Unified Network</div>
                            <div class="text-xs text-gray-400">Single ToR pair only - no spine layer support</div>
                        </div>
                    </div>
                    <div class="mt-3 p-3 bg-slate-800/50 rounded text-xs text-gray-400">
                        <div class="grid grid-cols-2 gap-2">
                            <div>✓ Fewer switches</div>
                            <div>✓ Lower cost</div>
                            <div>✓ Simpler cabling</div>
                            <div>• Shared bandwidth</div>
                        </div>
                    </div>
                `;
            }
            lucide.createIcons();
        }

        function wizardPrevStep() {
            if (wizardStep > 1) {
                wizardStep--;
                updateWizardStep();
            }
        }

        function selectWizardCapacityType(type) {
            wizardCapacityType = type;
            document.querySelectorAll('.wizard-cap-btn').forEach(btn => {
                btn.classList.remove('border-cyan-500', 'bg-cyan-900/30');
                btn.classList.add('border-slate-600');
            });
            const btn = document.getElementById(type === 'usable' ? 'wizardCapUsable' : 'wizardCapRaw');
            btn.classList.remove('border-slate-600');
            btn.classList.add('border-cyan-500', 'bg-cyan-900/30');
            updateWizardSizingPreview();
        }

        function selectWizardDriveOption(index) {
            wizardDriveOption = index;
            const driveIds = ['wizardDrive15', 'wizardDrive30', 'wizardDrive61'];
            const borderColors = ['border-cyan-500', 'border-purple-500', 'border-green-500'];
            const bgColors = ['bg-cyan-900/30', 'bg-purple-900/30', 'bg-green-900/30'];
            
            document.querySelectorAll('.wizard-drive-btn').forEach(btn => {
                btn.classList.remove('border-cyan-500', 'border-purple-500', 'border-green-500', 'bg-cyan-900/30', 'bg-purple-900/30', 'bg-green-900/30');
                btn.classList.add('border-slate-600');
            });
            
            const btn = document.getElementById(driveIds[index]);
            btn.classList.remove('border-slate-600');
            btn.classList.add(borderColors[index], bgColors[index]);
            updateWizardSizingPreview();
        }

        function selectWizardNetworkDesign(design) {
            wizardNetworkDesign = design;
            document.querySelectorAll('.wizard-net-btn').forEach(btn => {
                btn.classList.remove('border-green-500', 'border-yellow-500', 'bg-green-900/30', 'bg-yellow-900/30');
                btn.classList.add('border-slate-600');
            });
            const btn = document.getElementById(design === 'dedicated' ? 'wizardNetDedicated' : 'wizardNetUnified');
            btn.classList.remove('border-slate-600');
            btn.classList.add(design === 'dedicated' ? 'border-green-500' : 'border-yellow-500');
            btn.classList.add(design === 'dedicated' ? 'bg-green-900/30' : 'bg-yellow-900/30');
        }

        function selectWizardConnectionType(type) {
            wizardConnectionType = type;
            document.querySelectorAll('.wizard-conn-btn').forEach(btn => {
                btn.classList.remove('border-purple-500', 'border-cyan-500', 'bg-purple-900/30', 'bg-cyan-900/30');
                btn.classList.add('border-slate-600');
            });
            const btn = document.getElementById(type === 'direct' ? 'wizardConnDirect' : 'wizardConnBreakout');
            btn.classList.remove('border-slate-600');
            btn.classList.add(type === 'direct' ? 'border-purple-500' : 'border-cyan-500');
            btn.classList.add(type === 'direct' ? 'bg-purple-900/30' : 'bg-cyan-900/30');
        }

        function selectWizardRackLayout(layout) {
            wizardRackLayout = layout;
            document.querySelectorAll('.wizard-layout-btn').forEach(btn => {
                btn.classList.remove('border-cyan-500', 'border-purple-500', 'bg-cyan-900/30', 'bg-purple-900/30');
                btn.classList.add('border-slate-600');
            });
            const btn = document.getElementById(layout === 'single' ? 'wizardLayoutSingle' : 'wizardLayoutSplit');
            btn.classList.remove('border-slate-600');
            btn.classList.add(layout === 'single' ? 'border-cyan-500' : 'border-purple-500');
            btn.classList.add(layout === 'single' ? 'bg-cyan-900/30' : 'bg-purple-900/30');
            updateWizardRackPreview();
        }

        function setWizardRackPower(kw) {
            document.getElementById('wizardRackPower').value = kw;
            document.querySelectorAll('.wizard-power-btn').forEach(btn => {
                btn.classList.remove('bg-cyan-600');
                btn.classList.add('bg-slate-700');
            });
            event.target.classList.remove('bg-slate-700');
            event.target.classList.add('bg-cyan-600');
            updateWizardRackPreview();
        }

        function updateWizardSizingPreview() {
            const capacity = parseFloat(document.getElementById('wizardCapacity').value) || 10;
            const unit = document.getElementById('wizardCapacityUnit').value;
            const capacityTB = unit === 'PB' ? capacity * 1000 : capacity;
            
            // Capacity per server based on drive option
            const driveLabels = ['15.3TB', '30.7TB', '61.4TB'];
            const driveColors = ['cyan', 'purple', 'green'];
            const driveIds = ['wizardDrive15', 'wizardDrive30', 'wizardDrive61'];
            const usableCapacities = [100, 200, 350];
            const rawCapacities = [122.4, 245.6, 429.8];
            const minServers = 8;
            
            // Calculate servers needed for each drive option
            const serversNeeded = [];
            const driveValid = [];
            for (let i = 0; i < 3; i++) {
                const capPerServer = wizardCapacityType === 'usable' ? usableCapacities[i] : rawCapacities[i];
                const minCapacity = minServers * capPerServer;
                serversNeeded[i] = Math.max(minServers, Math.ceil(capacityTB / capPerServer));
                // Drive is valid if requested capacity doesn't exceed what min cluster can provide
                // (i.e., user isn't asking for less than min cluster can hold)
                driveValid[i] = capacityTB <= 0 || capacityTB >= minCapacity * 0.5; // Allow some flexibility
            }
            
            // Update drive option buttons - grey out invalid ones
            for (let i = 0; i < 3; i++) {
                const btn = document.getElementById(driveIds[i]);
                const capPerServer = wizardCapacityType === 'usable' ? usableCapacities[i] : rawCapacities[i];
                const minCapacity = minServers * capPerServer;
                
                if (!driveValid[i] && capacityTB > 0) {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    btn.innerHTML = `
                        <div class="font-semibold text-gray-500">${driveLabels[i]}</div>
                        <div class="text-xs text-gray-500">${usableCapacities[i]}TB/server</div>
                        <div class="text-xs text-red-400 mt-1">Min: ${minCapacity}TB</div>
                    `;
                } else {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    btn.innerHTML = `
                        <div class="font-semibold text-${driveColors[i]}-400">${driveLabels[i]}</div>
                        <div class="text-xs text-gray-400">${usableCapacities[i]}TB/server</div>
                    `;
                }
            }
            
            // If current selection is invalid, switch to first valid option
            if (!driveValid[wizardDriveOption] && capacityTB > 0) {
                for (let i = 0; i < 3; i++) {
                    if (driveValid[i]) {
                        selectWizardDriveOption(i);
                        return;
                    }
                }
            }
            
            const capPerServer = wizardCapacityType === 'usable' ? usableCapacities[wizardDriveOption] : rawCapacities[wizardDriveOption];
            const servers = Math.max(minServers, Math.ceil(capacityTB / capPerServer));
            
            const preview = document.getElementById('wizardSizingPreview');
            preview.textContent = `~${servers} EBox servers (${driveLabels[wizardDriveOption]} drives)`;
            preview.className = `text-${driveColors[wizardDriveOption]}-400 font-medium mt-1`;
            
            // Store servers needed for network design validation
            window.wizardServersNeeded = servers;
        }

        function updateWizardRackPreview() {
            const rackPower = parseFloat(document.getElementById('wizardRackPower').value) || 20;
            const isUnified = wizardNetworkDesign === 'unified';
            const isSplit = wizardRackLayout === 'split';
            
            const switchesInRack = isSplit ? (isUnified ? 1 : 2) : (isUnified ? 2 : 4);
            // Use 32-port switch power as default for wizard (638W, 1U)
            const switchPower = 638;
            const switchHeight = 1;
            const serverPower = 900;
            const switchPowerKw = switchesInRack * switchPower / 1000;
            const availablePower = rackPower - switchPowerKw;
            const maxServersByPower = Math.floor(availablePower * 1000 / serverPower);
            const maxServersBySpace = 42 - (switchesInRack * switchHeight);
            const maxServers = Math.min(maxServersByPower, maxServersBySpace);
            const serversPerSU = isSplit ? maxServers * 2 : maxServers;
            
            document.getElementById('wizardRackPreview').innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <div class="text-gray-400">Switches per rack:</div>
                        <div class="font-medium">${switchesInRack} ${isUnified ? '(unified)' : '(FE+BE)'}</div>
                    </div>
                    <div>
                        <div class="text-gray-400">Max servers per rack:</div>
                        <div class="font-medium">${maxServers}</div>
                    </div>
                    <div>
                        <div class="text-gray-400">Power for servers:</div>
                        <div class="font-medium">${availablePower.toFixed(1)} kW</div>
                    </div>
                    <div>
                        <div class="text-gray-400">Servers per scalable unit:</div>
                        <div class="font-medium text-cyan-400">${serversPerSU}</div>
                    </div>
                </div>
            `;
            
            // Update single rack description
            document.getElementById('wizardSingleDesc').textContent = `${switchesInRack} switches + servers in one rack`;
        }

        function finishWizard() {
            // Hide wizard FIRST
            document.getElementById('wizardOverlay').style.display = 'none';
            
            try {
                // Apply wizard settings to main calculator
                document.getElementById('capacity').value = document.getElementById('wizardCapacity').value;
                document.getElementById('capacity-unit').value = document.getElementById('wizardCapacityUnit').value;
                document.getElementById('capacity-type').value = wizardCapacityType;
                document.getElementById('drive-option').value = wizardDriveOption;
                document.getElementById('connectionType').value = wizardConnectionType;
                document.getElementById('rack-power').value = document.getElementById('wizardRackPower').value;
                
                // Apply network design
                selectedNetworkDesign = wizardNetworkDesign;
                selectNetworkDesign(wizardNetworkDesign);
                
                // Apply rack layout
                selectedRackLayout = wizardRackLayout;
                selectRackLayout(wizardRackLayout);
                
                // Calculate
                calculateMetrics();
                updateVisualizations();
            } catch (e) {
                console.error('Error applying wizard settings:', e);
            }
        }

        function skipWizard() {
            document.getElementById('wizardOverlay').style.display = 'none';
            calculateMetrics();
            updateVisualizations();
        }

        function showWizard() {
            wizardStep = 1;
            updateWizardStep();
            document.getElementById('wizardOverlay').style.display = 'flex';
        }

        // Initialize wizard preview updates
        document.getElementById('wizardCapacity').addEventListener('input', updateWizardSizingPreview);
        document.getElementById('wizardCapacityUnit').addEventListener('change', updateWizardSizingPreview);

        // Network design selection
        function selectNetworkDesign(design) {
            selectedNetworkDesign = design;
            document.querySelectorAll('.net-design-btn').forEach(btn => {
                btn.classList.remove('border-green-500', 'border-yellow-500', 'bg-green-900/30', 'bg-yellow-900/30');
                btn.classList.add('border-slate-600');
            });
            const btn = document.getElementById(design === 'dedicated' ? 'netDesignDedicated' : 'netDesignUnified');
            btn.classList.remove('border-slate-600');
            btn.classList.add(design === 'dedicated' ? 'border-green-500' : 'border-yellow-500');
            btn.classList.add(design === 'dedicated' ? 'bg-green-900/30' : 'bg-yellow-900/30');
            
            const desc = document.getElementById('network-design-description');
            const singleRackCount = document.getElementById('singleRackSwitchCount');
            if (design === 'dedicated') {
                desc.innerHTML = '<strong>Dedicated:</strong> Separate frontend and backend switch pairs. Maximum isolation and bandwidth.';
                singleRackCount.textContent = '4 switches in 1 rack';
            } else {
                desc.innerHTML = '<strong>Unified:</strong> Single ToR switch pair handles both FE/BE traffic. <span class="text-yellow-400">Cannot scale beyond single ToR pair (no spine support).</span>';
                singleRackCount.textContent = '2 switches in 1 rack';
            }
            
            // Update layout description based on both settings
            updateLayoutDescription();
            calculateMetrics();
            updateVisualizations();
        }

        function updateLayoutDescription() {
            const desc = document.getElementById('layout-description');
            const isUnified = selectedNetworkDesign === 'unified';
            const switchCount = isUnified ? 2 : 4;
            const switchDesc = isUnified ? '(unified FE/BE)' : '(2 FE + 2 BE)';
            
            if (selectedRackLayout === 'single') {
                desc.innerHTML = `<strong>Single rack:</strong> ${switchCount} switches ${switchDesc} + servers in one rack. More compact but power-limited.`;
            } else {
                const perRack = isUnified ? 1 : 2;
                desc.innerHTML = `<strong>Split:</strong> ${perRack} switch${perRack > 1 ? 'es' : ''} per rack. Fewer switches = more power for servers.`;
            }
        }

        // Rack layout selection
        function selectRackLayout(layout) {
            selectedRackLayout = layout;
            document.querySelectorAll('.rack-layout-btn').forEach(btn => {
                btn.classList.remove('border-cyan-500', 'border-purple-500', 'bg-cyan-900/30', 'bg-purple-900/30');
                btn.classList.add('border-slate-600');
            });
            const btn = document.getElementById(layout === 'single' ? 'layoutSingle' : 'layoutSplit');
            btn.classList.remove('border-slate-600');
            btn.classList.add(layout === 'single' ? 'border-cyan-500' : 'border-purple-500');
            btn.classList.add(layout === 'single' ? 'bg-cyan-900/30' : 'bg-purple-900/30');
            
            updateLayoutDescription();
            calculateMetrics();
            updateVisualizations();
        }

        // Pricing constants (pre-discounted with standard conservative discounts - not configurable)
        const PRICING = {
            serverCost: 26066.39,
            switchCost: 19475.05,
            serverOpticsCost: 155.88,
            spineOpticsCost: 875.00,
            drives: {
                '15.3TB': 5488.12,
                '30.7TB': 8291.25,
                '61.4TB': 15451.88,
                '960GB': 1870.51,
                '1.92TB': 3481.22
            }
        };

        const CONFIG = {
            serversPerRack: 30,
            switchesPerRack: 2,
            opticsPerServer: 2,
            spineOpticsPerSwitch: 4,
            minServers: 8,
            serverPower: 900,        // Watts per EBox server
            switchPower32: 638,      // Watts per 32-port 1U switch (N9K-C9332D-GX2B typical)
            switchPower64: 950,      // Watts per 64-port 2U switch (N9K-C9364D-GX2A typical)
            rackUnits: 42,
            serverHeight: 1,         // 1U per server
            switchHeight32: 1,       // 1U per 32-port switch
            switchHeight64: 2,       // 2U per 64-port switch
            defaultRackPower: 20,    // kW per rack
            // Network config: 2x ConnectX-7 per server
            // Each CX7 has 2x200G ports
            // One NIC for frontend, one for backend
            nicsPerServer: 2,
            portsPerNic: 2,
            portSpeed: '200G'
        };

        // Drive costs per server for each option
        const driveCosts = [
            (8 * PRICING.drives['15.3TB'] + 2 * PRICING.drives['960GB']),
            (8 * PRICING.drives['30.7TB'] + 2 * PRICING.drives['1.92TB']),
            (7 * PRICING.drives['61.4TB'] + 3 * PRICING.drives['1.92TB'])
        ];

        // Capacity per server (raw and usable)
        const capacities = [
            { raw: 122.40, usable: 100.00 },
            { raw: 245.60, usable: 200.00 },
            { raw: 429.80, usable: 350.00 }
        ];

        function calculateMetrics() {
            const capacity = parseFloat(document.getElementById('capacity').value) || 0;
            const capacityUnit = document.getElementById('capacity-unit').value;
            const capacityType = document.getElementById('capacity-type').value;

            const capacityInTB = capacityUnit === 'PB' ? capacity * 1000 : capacity;
            const capacityKey = capacityType === 'raw' ? 'raw' : 'usable';

            const serversRequired = capacities.map(cap => 
                Math.max(CONFIG.minServers, Math.ceil(capacityInTB / cap[capacityKey] || 0))
            );
            const racksRequired = serversRequired.map(servers => 
                Math.ceil(servers / CONFIG.serversPerRack)
            );

            // Update sizing results
            const sizingResults = document.getElementById('sizing-results');
            if (capacity > 0) {
                // Check if capacity is below minimum cluster size for each drive option
                const minClusterCapacities = capacities.map(cap => CONFIG.minServers * cap[capacityKey]);
                const driveLabels = ['15.3TB', '30.7TB', '61.4TB'];
                const driveColors = ['cyan', 'purple', 'green'];
                
                // Calculate actual servers needed (before min enforcement)
                const actualServersNeeded = capacities.map(cap => Math.ceil(capacityInTB / cap[capacityKey] || 0));
                
                let warningHTML = '';
                const warnings = [];
                for (let i = 0; i < 3; i++) {
                    if (actualServersNeeded[i] < CONFIG.minServers && capacityInTB > 0) {
                        const minCapacity = minClusterCapacities[i];
                        warnings.push(`<span class="text-${driveColors[i]}-400">${driveLabels[i]}</span>: min ${minCapacity.toLocaleString()} TB ${capacityType} (${CONFIG.minServers} servers)`);
                    }
                }
                
                if (warnings.length > 0) {
                    warningHTML = `
                        <div class="mt-3 p-3 bg-yellow-900/30 border border-yellow-500/50 rounded-lg">
                            <div class="flex items-start gap-2">
                                <i data-lucide="alert-triangle" class="w-4 h-4 text-yellow-400 mt-0.5 flex-shrink-0"></i>
                                <div class="text-xs">
                                    <div class="text-yellow-400 font-medium mb-1">Below minimum cluster size (${CONFIG.minServers} servers)</div>
                                    <div class="text-gray-400">Minimum usable capacity by drive option:</div>
                                    <div class="mt-1">${warnings.join('<br>')}</div>
                                    <div class="text-gray-500 mt-2">Cluster will be sized to minimum ${CONFIG.minServers} servers with excess capacity.</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                sizingResults.innerHTML = `
                    <div class="space-y-2">
                        <p><strong>For ${capacity} ${capacityUnit} of ${capacityType} capacity:</strong></p>
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div class="p-2 bg-cyan-900/30 rounded ${actualServersNeeded[0] < CONFIG.minServers ? 'border border-yellow-500/50' : ''}">
                                <div class="text-cyan-400 font-bold">${serversRequired[0]}</div>
                                <div class="text-xs">15.3TB servers</div>
                                ${actualServersNeeded[0] < CONFIG.minServers ? '<div class="text-yellow-400 text-xs mt-1">⚠ oversized</div>' : ''}
                            </div>
                            <div class="p-2 bg-purple-900/30 rounded ${actualServersNeeded[1] < CONFIG.minServers ? 'border border-yellow-500/50' : ''}">
                                <div class="text-purple-400 font-bold">${serversRequired[1]}</div>
                                <div class="text-xs">30.7TB servers</div>
                                ${actualServersNeeded[1] < CONFIG.minServers ? '<div class="text-yellow-400 text-xs mt-1">⚠ oversized</div>' : ''}
                            </div>
                            <div class="p-2 bg-green-900/30 rounded ${actualServersNeeded[2] < CONFIG.minServers ? 'border border-yellow-500/50' : ''}">
                                <div class="text-green-400 font-bold">${serversRequired[2]}</div>
                                <div class="text-xs">61.4TB servers</div>
                                ${actualServersNeeded[2] < CONFIG.minServers ? '<div class="text-yellow-400 text-xs mt-1">⚠ oversized</div>' : ''}
                            </div>
                        </div>
                        ${warningHTML}
                    </div>
                `;
                lucide.createIcons();
            } else {
                sizingResults.textContent = `Enter capacity to see the number of servers and racks required (minimum ${CONFIG.minServers} servers per cluster).`;
            }

            // Get table cells
            const rawCapacityCells = document.querySelectorAll('.raw-capacity');
            const usableCapacityCells = document.querySelectorAll('.usable-capacity');
            const serversRequiredCells = document.querySelectorAll('.servers-required');
            const racksRequiredCells = document.querySelectorAll('.racks-required');
            const totalRackUnitsCells = document.querySelectorAll('.total-rack-units');
            const networkSwitchesCells = document.querySelectorAll('.network-switches');
            const opticsCountCells = document.querySelectorAll('.optics-count');
            const spineOpticsCountCells = document.querySelectorAll('.spine-optics-count');
            const totalSolutionPriceCells = document.querySelectorAll('.total-solution-price');
            const pricePerUsableTbCells = document.querySelectorAll('.price-per-usable-tb');
            const costBreakdownCells = document.querySelectorAll('.cost-breakdown');

            // Calculate for each option
            for (let i = 0; i < 3; i++) {
                const servers = serversRequired[i];
                const racks = racksRequired[i];
                const switches = racks * CONFIG.switchesPerRack;
                const serverOptics = servers * CONFIG.opticsPerServer;
                const spineOptics = switches * CONFIG.spineOpticsPerSwitch;
                
                const serverCostTotal = PRICING.serverCost * servers;
                const driveCostTotal = driveCosts[i] * servers;
                const switchesCostTotal = switches * PRICING.switchCost;
                const serverOpticsCostTotal = serverOptics * PRICING.serverOpticsCost;
                const spineOpticsCostTotal = spineOptics * PRICING.spineOpticsCost;

                const totalPrice = serverCostTotal + driveCostTotal + switchesCostTotal + serverOpticsCostTotal + spineOpticsCostTotal;

                rawCapacityCells[i].textContent = capacities[i].raw.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                usableCapacityCells[i].textContent = capacities[i].usable.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                serversRequiredCells[i].textContent = servers.toLocaleString('en-US');
                racksRequiredCells[i].textContent = racks.toLocaleString('en-US');
                totalRackUnitsCells[i].textContent = (servers + switches).toLocaleString('en-US');
                networkSwitchesCells[i].textContent = switches.toLocaleString('en-US');
                opticsCountCells[i].textContent = serverOptics.toLocaleString('en-US');
                spineOpticsCountCells[i].textContent = spineOptics.toLocaleString('en-US');
                totalSolutionPriceCells[i].textContent = totalPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                pricePerUsableTbCells[i].textContent = (totalPrice / (servers * capacities[i].usable)).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                costBreakdownCells[i].innerHTML = `Servers: ${serverCostTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}<br>Drives: ${driveCostTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}<br>Switches: ${switchesCostTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}<br>Server Optics: ${serverOpticsCostTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}<br>Spine Optics: ${spineOpticsCostTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            }
        }

        // Generate rack visualization
        function generateRackVisualization(servers, racks, elementId, infoId, color) {
            const container = document.getElementById(elementId);
            const infoContainer = document.getElementById(infoId);
            const rackPower = parseFloat(document.getElementById('rack-power').value) || CONFIG.defaultRackPower;
            const isSplit = selectedRackLayout === 'split';
            const isUnified = selectedNetworkDesign === 'unified';
            const connectionType = document.getElementById('connectionType')?.value || 'direct';
            const switchType = document.getElementById('switchType')?.value || '32port';
            
            // Get switch power and height based on type
            const switchPower = switchType === '64port' ? CONFIG.switchPower64 : CONFIG.switchPower32;
            const switchHeight = switchType === '64port' ? CONFIG.switchHeight64 : CONFIG.switchHeight32;
            
            // Calculate switch count based on network design
            // Dedicated: 4 switches (2 FE + 2 BE) for single, 2 per rack for split
            // Unified: 2 switches total for single, 1 per rack for split
            let switchesInRack, switchPowerPerRack, maxServersBySpace, serversPerRack, serversPerScalableUnit, racksPerScalableUnit;
            
            if (isSplit) {
                // Split: switches per rack depends on unified vs dedicated
                switchesInRack = isUnified ? 1 : 2;
                switchPowerPerRack = switchesInRack * switchPower / 1000;
                const availablePowerForServers = rackPower - switchPowerPerRack;
                const maxServersByPower = Math.floor(availablePowerForServers * 1000 / CONFIG.serverPower);
                maxServersBySpace = CONFIG.rackUnits - (switchesInRack * switchHeight);
                serversPerRack = Math.min(maxServersByPower, maxServersBySpace);
                serversPerScalableUnit = serversPerRack * 2; // 2 racks per scalable unit
                racksPerScalableUnit = 2;
            } else {
                // Single: switches in rack depends on unified vs dedicated
                switchesInRack = isUnified ? 2 : 4;
                switchPowerPerRack = switchesInRack * switchPower / 1000;
                const availablePowerForServers = rackPower - switchPowerPerRack;
                const maxServersByPower = Math.floor(availablePowerForServers * 1000 / CONFIG.serverPower);
                maxServersBySpace = CONFIG.rackUnits - (switchesInRack * switchHeight);
                serversPerRack = Math.min(maxServersByPower, maxServersBySpace);
                serversPerScalableUnit = serversPerRack;
                racksPerScalableUnit = 1;
            }
            
            const scalableUnits = Math.ceil(servers / serversPerScalableUnit);
            const actualRacks = scalableUnits * racksPerScalableUnit;
            const limitedBy = (rackPower - switchPowerPerRack) * 1000 / CONFIG.serverPower <= maxServersBySpace ? 'Power' : 'Space';
            
            // Generate rack HTML
            // For split design, distribute servers evenly across both racks
            const serversInFirstRack = isSplit ? Math.ceil(Math.min(servers, serversPerScalableUnit) / 2) : Math.min(servers, serversPerRack);
            const serversInSecondRack = isSplit ? Math.floor(Math.min(servers, serversPerScalableUnit) / 2) : 0;
            
            if (isSplit) {
                // Show both racks of the scalable unit
                let rackHTML = '<div class="text-xs text-gray-500 mb-1">Scalable Unit 1 of ' + scalableUnits + ' (' + actualRacks + ' racks total)</div>';
                rackHTML += '<div class="grid grid-cols-2 gap-2">';
                
                // Rack A
                rackHTML += '<div class="border border-slate-600 rounded">';
                rackHTML += '<div class="text-xs text-center text-gray-500 py-1 bg-slate-800">Rack A (' + serversInFirstRack + ' servers)</div>';
                let unitIndexA = CONFIG.rackUnits;
                if (isUnified) {
                    rackHTML += `<div class="rack-unit rack-switch-fe text-white text-xs" style="background: linear-gradient(90deg, #7c3aed 50%, #059669 50%);">Unified</div>`;
                    unitIndexA -= 1;
                } else {
                    rackHTML += `<div class="rack-unit rack-switch-fe text-white text-xs">FE Leaf</div>`;
                    rackHTML += `<div class="rack-unit rack-switch-be text-white text-xs">BE Leaf</div>`;
                    unitIndexA -= 2;
                }
                for (let i = 0; i < serversInFirstRack && unitIndexA > 0; i++) {
                    rackHTML += `<div class="rack-unit rack-server text-white text-xs">EBox ${i + 1}</div>`;
                    unitIndexA--;
                }
                while (unitIndexA > 0) {
                    rackHTML += `<div class="rack-unit rack-empty text-gray-600 text-xs">${unitIndexA}U</div>`;
                    unitIndexA--;
                }
                rackHTML += '</div>';
                
                // Rack B
                rackHTML += '<div class="border border-slate-600 rounded">';
                rackHTML += '<div class="text-xs text-center text-gray-500 py-1 bg-slate-800">Rack B (' + serversInSecondRack + ' servers)</div>';
                let unitIndexB = CONFIG.rackUnits;
                if (isUnified) {
                    rackHTML += `<div class="rack-unit rack-switch-fe text-white text-xs" style="background: linear-gradient(90deg, #7c3aed 50%, #059669 50%);">Unified</div>`;
                    unitIndexB -= 1;
                } else {
                    rackHTML += `<div class="rack-unit rack-switch-fe text-white text-xs">FE Leaf</div>`;
                    rackHTML += `<div class="rack-unit rack-switch-be text-white text-xs">BE Leaf</div>`;
                    unitIndexB -= 2;
                }
                for (let i = 0; i < serversInSecondRack && unitIndexB > 0; i++) {
                    rackHTML += `<div class="rack-unit rack-server text-white text-xs">EBox ${serversInFirstRack + i + 1}</div>`;
                    unitIndexB--;
                }
                while (unitIndexB > 0) {
                    rackHTML += `<div class="rack-unit rack-empty text-gray-600 text-xs">${unitIndexB}U</div>`;
                    unitIndexB--;
                }
                rackHTML += '</div>';
                
                rackHTML += '</div>';
                
                // Split rack info
                rackHTML += `<div class="mt-2 p-2 bg-purple-900/20 border border-purple-500/30 rounded text-xs text-purple-300">
                    <i data-lucide="zap" class="w-3 h-3 inline"></i> Split layout: Servers evenly distributed (${serversInFirstRack} + ${serversInSecondRack} = ${serversInFirstRack + serversInSecondRack} per scalable unit)
                </div>`;
                
                container.innerHTML = rackHTML;
                lucide.createIcons();
            } else {
                // Single rack layout
                let rackHTML = '<div class="text-xs text-gray-500 mb-1">Rack 1 of ' + actualRacks + '</div>';
                rackHTML += '<div class="border border-slate-600 rounded">';
                
                let unitIndex = CONFIG.rackUnits;
                if (isUnified) {
                    rackHTML += `<div class="rack-unit rack-switch-fe text-white" style="background: linear-gradient(90deg, #7c3aed 50%, #059669 50%);">Unified 1</div>`;
                    rackHTML += `<div class="rack-unit rack-switch-fe text-white" style="background: linear-gradient(90deg, #7c3aed 50%, #059669 50%);">Unified 2</div>`;
                    unitIndex -= 2;
                } else {
                    rackHTML += `<div class="rack-unit rack-switch-fe text-white">FE Leaf 1</div>`;
                    rackHTML += `<div class="rack-unit rack-switch-fe text-white">FE Leaf 2</div>`;
                    rackHTML += `<div class="rack-unit rack-switch-be text-white">BE Leaf 1</div>`;
                    rackHTML += `<div class="rack-unit rack-switch-be text-white">BE Leaf 2</div>`;
                    unitIndex -= 4;
                }
                
                for (let i = 0; i < serversInFirstRack && unitIndex > 0; i++) {
                    rackHTML += `<div class="rack-unit rack-server text-white">EBox ${i + 1}</div>`;
                    unitIndex--;
                }
                
                while (unitIndex > 0) {
                    rackHTML += `<div class="rack-unit rack-empty text-gray-600">${unitIndex}U</div>`;
                    unitIndex--;
                }
                
                rackHTML += '</div>';
                container.innerHTML = rackHTML;
            }
            
            // Info
            const powerPerRack = (serversPerRack * CONFIG.serverPower + switchesInRack * switchPower) / 1000;
            infoContainer.innerHTML = `
                <div>${serversPerRack} servers/rack • ${isSplit ? serversPerScalableUnit + ' per scalable unit • ' : ''}${actualRacks} racks</div>
                <div class="text-${limitedBy === 'Power' ? 'yellow' : 'blue'}-400">${powerPerRack.toFixed(1)} kW/rack (${limitedBy} limited)</div>
            `;
            
            return { actualRacks, serversPerRack, serversPerScalableUnit, powerPerRack, limitedBy, isSplit, scalableUnits };
        }
        
        // Update power summary
        function updatePowerSummary(results) {
            const rackPower = parseFloat(document.getElementById('rack-power').value) || CONFIG.defaultRackPower;
            const isSplit = selectedRackLayout === 'split';
            const isUnified = selectedNetworkDesign === 'unified';
            const connectionType = document.getElementById('connectionType')?.value || 'direct';
            const switchType = document.getElementById('switchType')?.value || '32port';
            
            // Get switch power and height based on type
            const switchPower = switchType === '64port' ? CONFIG.switchPower64 : CONFIG.switchPower32;
            const switchHeight = switchType === '64port' ? CONFIG.switchHeight64 : CONFIG.switchHeight32;
            const switchLabel = switchType === '64port' ? '64-port 2U' : '32-port 1U';
            
            // Calculate switches based on layout and design
            let switchesInRack;
            if (isSplit) {
                switchesInRack = isUnified ? 1 : 2;
            } else {
                switchesInRack = isUnified ? 2 : 4;
            }
            
            const switchPowerPerRack = switchesInRack * switchPower / 1000;
            const availablePowerForServers = rackPower - switchPowerPerRack;
            const maxServersByPower = Math.floor(availablePowerForServers * 1000 / CONFIG.serverPower);
            const maxServersBySpace = CONFIG.rackUnits - (switchesInRack * switchHeight);
            const serversPerRack = Math.min(maxServersByPower, maxServersBySpace);
            const serversPerScalableUnit = isSplit ? serversPerRack * 2 : serversPerRack;
            
            const designLabel = isUnified ? 'Unified' : 'Dedicated';
            const connectionLabel = connectionType === 'breakout' ? '400G→2×200G breakout' : 'Direct 200G';
            
            document.getElementById('power-summary').innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div>
                        <div class="text-yellow-400 font-bold">${CONFIG.serverPower}W</div>
                        <div class="text-xs text-gray-400">Per Server</div>
                    </div>
                    <div>
                        <div class="text-purple-400 font-bold">${switchPower}W</div>
                        <div class="text-xs text-gray-400">Per Switch (${switchLabel})</div>
                    </div>
                    <div>
                        <div class="text-cyan-400 font-bold">${switchPowerPerRack.toFixed(1)} kW</div>
                        <div class="text-xs text-gray-400">Switches/Rack (${switchesInRack}×${switchHeight}U)</div>
                    </div>
                    <div>
                        <div class="text-green-400 font-bold">${serversPerRack}</div>
                        <div class="text-xs text-gray-400">Max Servers/Rack</div>
                    </div>
                </div>
                <div class="mt-3 text-xs text-gray-400 text-center">
                    Rack budget: ${rackPower} kW • Available for servers: ${availablePowerForServers.toFixed(1)} kW
                    <br><span class="${isUnified ? 'text-yellow-400' : 'text-green-400'}">${designLabel} network</span> • <span class="text-cyan-400">${connectionLabel}</span>
                    ${isSplit ? `<br><span class="text-purple-400">Split layout: ${serversPerScalableUnit} servers per scalable unit (2 racks)</span>` : ''}
                </div>
            `;
        }
        
        // Update network diagram
        function updateNetworkDiagram(servers, racks, result) {
            const isSplit = selectedRackLayout === 'split';
            const isUnified = selectedNetworkDesign === 'unified';
            const connectionType = document.getElementById('connectionType')?.value || 'direct';
            
            // Calculate actual switch count based on design
            let totalSwitches;
            if (isUnified) {
                totalSwitches = isSplit ? racks : racks * 2; // 1 per rack for split, 2 per rack for single
            } else {
                totalSwitches = racks * 2; // 2 per rack (FE + BE) for dedicated
            }
            // switches = number of leaf switches per network (FE or BE)
            const switches = isUnified ? totalSwitches : totalSwitches / 2;
            
            const connectionDesc = connectionType === 'breakout' ? '400G→2×200G breakout' : '2×200G direct';
            const totalPorts = servers * CONFIG.nicsPerServer * CONFIG.portsPerNic;
            
            // Frontend network info
            document.getElementById('frontend-network-info').innerHTML = `
                <div class="space-y-1">
                    <div class="flex justify-between"><span class="text-gray-400">Leaf Switches:</span><span class="text-purple-400">${isUnified ? totalSwitches + ' (shared)' : totalSwitches / 2}</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">Connection:</span><span>${connectionDesc}</span></div>
                    ${isSplit ? '<div class="text-purple-400 text-xs mt-1">Cross-cabled to both racks</div>' : ''}
                </div>
            `;
            
            // Backend network info
            document.getElementById('backend-network-info').innerHTML = `
                <div class="space-y-1">
                    <div class="flex justify-between"><span class="text-gray-400">Leaf Switches:</span><span class="text-green-400">${isUnified ? totalSwitches + ' (shared)' : totalSwitches / 2}</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">Connection:</span><span>${connectionDesc}</span></div>
                    ${isSplit ? '<div class="text-green-400 text-xs mt-1">Cross-cabled to both racks</div>' : ''}
                </div>
            `;
            
            // Network diagram - different for split vs single and unified vs dedicated
            let diagramHTML;
            const breakoutLabel = connectionType === 'breakout' ? ' (400G→2×200G)' : '';
            
            if (isUnified) {
                // Unified network diagram
                diagramHTML = `
                <div class="min-w-[600px]">
                    <svg viewBox="0 0 600 280" class="w-full">
                        <!-- Title -->
                        <text x="300" y="15" text-anchor="middle" fill="#eab308" font-size="12" font-weight="bold">Unified Network Design${breakoutLabel}</text>
                        
                        <!-- Spine Layer -->
                        <text x="300" y="40" text-anchor="middle" fill="#9ca3af" font-size="11">Spine Layer (Unified FE/BE)</text>
                        <rect x="170" y="48" width="120" height="28" rx="4" fill="url(#unifiedGrad)" stroke="#eab308" stroke-width="2"/>
                        <text x="230" y="67" text-anchor="middle" fill="white" font-size="10">Unified Spine 1</text>
                        <rect x="310" y="48" width="120" height="28" rx="4" fill="url(#unifiedGrad)" stroke="#eab308" stroke-width="2"/>
                        <text x="370" y="67" text-anchor="middle" fill="white" font-size="10">Unified Spine 2</text>
                        
                        <!-- Gradient definition -->
                        <defs>
                            <linearGradient id="unifiedGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#7c3aed"/>
                                <stop offset="50%" style="stop-color:#7c3aed"/>
                                <stop offset="50%" style="stop-color:#059669"/>
                                <stop offset="100%" style="stop-color:#059669"/>
                            </linearGradient>
                        </defs>
                        
                        <!-- Leaf Layer -->
                        <text x="300" y="105" text-anchor="middle" fill="#9ca3af" font-size="11">Leaf Layer (${totalSwitches} unified switches - virtual FE/BE split)</text>
                        <rect x="120" y="115" width="100" height="25" rx="4" fill="url(#unifiedGrad)" stroke="#eab308"/>
                        <text x="170" y="132" text-anchor="middle" fill="white" font-size="9">Unified Leaf 1</text>
                        <rect x="240" y="115" width="100" height="25" rx="4" fill="url(#unifiedGrad)" stroke="#eab308"/>
                        <text x="290" y="132" text-anchor="middle" fill="white" font-size="9">Unified Leaf 2</text>
                        <text x="365" y="132" fill="#6b7280" font-size="10">...</text>
                        <rect x="400" y="115" width="100" height="25" rx="4" fill="url(#unifiedGrad)" stroke="#eab308"/>
                        <text x="450" y="132" text-anchor="middle" fill="white" font-size="9">Unified Leaf N</text>
                        
                        <!-- Server Layer -->
                        <text x="300" y="175" text-anchor="middle" fill="#9ca3af" font-size="11">EBox Servers (${servers} servers × 2 NICs × 2 ports)</text>
                        <rect x="100" y="185" width="100" height="35" rx="4" fill="#0891b2" stroke="#22d3ee" stroke-width="2"/>
                        <text x="150" y="200" text-anchor="middle" fill="white" font-size="9">EBox Server 1</text>
                        <text x="150" y="213" text-anchor="middle" fill="#a5f3fc" font-size="7">CX7×2 → Unified</text>
                        
                        <text x="230" y="205" fill="#6b7280" font-size="14">...</text>
                        
                        <rect x="270" y="185" width="100" height="35" rx="4" fill="#0891b2" stroke="#22d3ee" stroke-width="2"/>
                        <text x="320" y="200" text-anchor="middle" fill="white" font-size="9">EBox Server N</text>
                        <text x="320" y="213" text-anchor="middle" fill="#a5f3fc" font-size="7">CX7×2 → Unified</text>
                        
                        <!-- Connection lines -->
                        <line x1="150" y1="185" x2="170" y2="140" stroke="#eab308" stroke-width="1.5" opacity="0.6"/>
                        <line x1="320" y1="185" x2="290" y2="140" stroke="#eab308" stroke-width="1.5" opacity="0.6"/>
                        
                        <!-- Legend -->
                        <rect x="50" y="240" width="12" height="12" rx="2" fill="url(#unifiedGrad)"/>
                        <text x="68" y="250" fill="#9ca3af" font-size="9">Unified Switch</text>
                        <rect x="160" y="240" width="12" height="12" rx="2" fill="#0891b2"/>
                        <text x="178" y="250" fill="#9ca3af" font-size="9">EBox Servers</text>
                        
                        <!-- Optics/Speeds -->
                        <text x="50" y="268" fill="#6b7280" font-size="8">Optics: Server→Leaf: ${connectionType === 'breakout' ? '400G (2×200G breakout)' : '200G'} | Leaf→Spine: 400G</text>
                    </svg>
                </div>
            `;
            } else if (isSplit) {
                // Split rack diagram with cross-cabling (dedicated)
                diagramHTML = `
                <div class="min-w-[600px]">
                    <svg viewBox="0 0 600 320" class="w-full">
                        <!-- Title -->
                        <text x="300" y="15" text-anchor="middle" fill="#a855f7" font-size="12" font-weight="bold">Split Rack Layout with Cross-Cabling${breakoutLabel}</text>
                        
                        <!-- Spine Layer -->
                        <text x="300" y="40" text-anchor="middle" fill="#9ca3af" font-size="11">Spine Layer</text>
                        <rect x="120" y="48" width="70" height="25" rx="4" fill="#7c3aed" stroke="#8b5cf6" stroke-width="2"/>
                        <text x="155" y="65" text-anchor="middle" fill="white" font-size="9">FE Spine 1</text>
                        <rect x="200" y="48" width="70" height="25" rx="4" fill="#7c3aed" stroke="#8b5cf6" stroke-width="2"/>
                        <text x="235" y="65" text-anchor="middle" fill="white" font-size="9">FE Spine 2</text>
                        <rect x="330" y="48" width="70" height="25" rx="4" fill="#059669" stroke="#10b981" stroke-width="2"/>
                        <text x="365" y="65" text-anchor="middle" fill="white" font-size="9">BE Spine 1</text>
                        <rect x="410" y="48" width="70" height="25" rx="4" fill="#059669" stroke="#10b981" stroke-width="2"/>
                        <text x="445" y="65" text-anchor="middle" fill="white" font-size="9">BE Spine 2</text>
                        
                        <!-- Rack Labels -->
                        <rect x="50" y="95" width="200" height="180" rx="4" fill="none" stroke="#475569" stroke-width="1" stroke-dasharray="4"/>
                        <text x="150" y="110" text-anchor="middle" fill="#64748b" font-size="10">Rack A</text>
                        <rect x="350" y="95" width="200" height="180" rx="4" fill="none" stroke="#475569" stroke-width="1" stroke-dasharray="4"/>
                        <text x="450" y="110" text-anchor="middle" fill="#64748b" font-size="10">Rack B</text>
                        
                        <!-- Leaf Switches in Rack A -->
                        <rect x="70" y="120" width="70" height="22" rx="4" fill="#7c3aed" stroke="#8b5cf6"/>
                        <text x="105" y="135" text-anchor="middle" fill="white" font-size="8">FE Leaf A</text>
                        <rect x="150" y="120" width="70" height="22" rx="4" fill="#059669" stroke="#10b981"/>
                        <text x="185" y="135" text-anchor="middle" fill="white" font-size="8">BE Leaf A</text>
                        
                        <!-- Leaf Switches in Rack B -->
                        <rect x="370" y="120" width="70" height="22" rx="4" fill="#7c3aed" stroke="#8b5cf6"/>
                        <text x="405" y="135" text-anchor="middle" fill="white" font-size="8">FE Leaf B</text>
                        <rect x="450" y="120" width="70" height="22" rx="4" fill="#059669" stroke="#10b981"/>
                        <text x="485" y="135" text-anchor="middle" fill="white" font-size="8">BE Leaf B</text>
                        
                        <!-- Spine to Leaf connections -->
                        <line x1="155" y1="73" x2="105" y2="120" stroke="#8b5cf6" stroke-width="1" opacity="0.4"/>
                        <line x1="155" y1="73" x2="405" y2="120" stroke="#8b5cf6" stroke-width="1" opacity="0.4"/>
                        <line x1="235" y1="73" x2="105" y2="120" stroke="#8b5cf6" stroke-width="1" opacity="0.4"/>
                        <line x1="235" y1="73" x2="405" y2="120" stroke="#8b5cf6" stroke-width="1" opacity="0.4"/>
                        <line x1="365" y1="73" x2="185" y2="120" stroke="#10b981" stroke-width="1" opacity="0.4"/>
                        <line x1="365" y1="73" x2="485" y2="120" stroke="#10b981" stroke-width="1" opacity="0.4"/>
                        <line x1="445" y1="73" x2="185" y2="120" stroke="#10b981" stroke-width="1" opacity="0.4"/>
                        <line x1="445" y1="73" x2="485" y2="120" stroke="#10b981" stroke-width="1" opacity="0.4"/>
                        
                        <!-- Servers in Rack A -->
                        <rect x="80" y="155" width="130" height="30" rx="4" fill="#0891b2" stroke="#22d3ee" stroke-width="2"/>
                        <text x="145" y="168" text-anchor="middle" fill="white" font-size="8">EBox Servers (Rack A)</text>
                        <text x="145" y="180" text-anchor="middle" fill="#a5f3fc" font-size="7">CX7×2 per server</text>
                        
                        <!-- Servers in Rack B -->
                        <rect x="380" y="155" width="130" height="30" rx="4" fill="#0891b2" stroke="#22d3ee" stroke-width="2"/>
                        <text x="445" y="168" text-anchor="middle" fill="white" font-size="8">EBox Servers (Rack B)</text>
                        <text x="445" y="180" text-anchor="middle" fill="#a5f3fc" font-size="7">CX7×2 per server</text>
                        
                        <!-- Cross-cabling lines (servers to both racks' switches) -->
                        <!-- Rack A servers to Rack A switches -->
                        <line x1="100" y1="155" x2="105" y2="142" stroke="#8b5cf6" stroke-width="1.5" opacity="0.6"/>
                        <line x1="120" y1="155" x2="185" y2="142" stroke="#10b981" stroke-width="1.5" opacity="0.6"/>
                        <!-- Rack A servers to Rack B switches (cross-cable) -->
                        <line x1="180" y1="155" x2="405" y2="142" stroke="#8b5cf6" stroke-width="1.5" stroke-dasharray="3" opacity="0.8"/>
                        <line x1="200" y1="155" x2="485" y2="142" stroke="#10b981" stroke-width="1.5" stroke-dasharray="3" opacity="0.8"/>
                        
                        <!-- Rack B servers to Rack B switches -->
                        <line x1="490" y1="155" x2="485" y2="142" stroke="#10b981" stroke-width="1.5" opacity="0.6"/>
                        <line x1="470" y1="155" x2="405" y2="142" stroke="#8b5cf6" stroke-width="1.5" opacity="0.6"/>
                        <!-- Rack B servers to Rack A switches (cross-cable) -->
                        <line x1="410" y1="155" x2="185" y2="142" stroke="#10b981" stroke-width="1.5" stroke-dasharray="3" opacity="0.8"/>
                        <line x1="390" y1="155" x2="105" y2="142" stroke="#8b5cf6" stroke-width="1.5" stroke-dasharray="3" opacity="0.8"/>
                        
                        <!-- Cross-cable label -->
                        <text x="300" y="210" text-anchor="middle" fill="#a855f7" font-size="9">↔ Cross-cabled: Each server connects to switches in BOTH racks</text>
                        
                        <!-- Legend -->
                        <rect x="80" y="230" width="10" height="10" rx="2" fill="#7c3aed"/>
                        <text x="95" y="239" fill="#9ca3af" font-size="9">Frontend</text>
                        <rect x="150" y="230" width="10" height="10" rx="2" fill="#059669"/>
                        <text x="165" y="239" fill="#9ca3af" font-size="9">Backend</text>
                        <rect x="220" y="230" width="10" height="10" rx="2" fill="#0891b2"/>
                        <text x="235" y="239" fill="#9ca3af" font-size="9">Servers</text>
                        <line x1="300" y1="235" x2="330" y2="235" stroke="#9ca3af" stroke-width="1.5" stroke-dasharray="3"/>
                        <text x="340" y="239" fill="#9ca3af" font-size="9">Cross-cable</text>
                        
                        <!-- Stats -->
                        <text x="300" y="260" text-anchor="middle" fill="#9ca3af" font-size="10">${servers} servers × 4 ports = ${servers * 4} connections (${switches} FE + ${switches} BE leaf switches)</text>
                        
                        <!-- Optics/Speeds -->
                        <text x="300" y="280" text-anchor="middle" fill="#6b7280" font-size="8">Optics: Server→Leaf: ${connectionType === 'breakout' ? '400G (2×200G breakout)' : '200G'} | Leaf→Spine: 400G</text>
                    </svg>
                </div>
            `;
            } else {
                // Single rack diagram (dedicated)
                diagramHTML = `
                <div class="min-w-[600px]">
                    <svg viewBox="0 0 600 280" class="w-full">
                        <!-- Title -->
                        <text x="300" y="15" text-anchor="middle" fill="#22d3ee" font-size="12" font-weight="bold">Dedicated Network Design${breakoutLabel}</text>
                        <!-- Spine Layer -->
                        <text x="300" y="35" text-anchor="middle" fill="#9ca3af" font-size="11">Spine Layer</text>
                        <rect x="120" y="30" width="80" height="30" rx="4" fill="#7c3aed" stroke="#8b5cf6" stroke-width="2"/>
                        <text x="160" y="50" text-anchor="middle" fill="white" font-size="10">FE Spine 1</text>
                        <rect x="220" y="30" width="80" height="30" rx="4" fill="#7c3aed" stroke="#8b5cf6" stroke-width="2"/>
                        <text x="260" y="50" text-anchor="middle" fill="white" font-size="10">FE Spine 2</text>
                        <rect x="320" y="30" width="80" height="30" rx="4" fill="#059669" stroke="#10b981" stroke-width="2"/>
                        <text x="360" y="50" text-anchor="middle" fill="white" font-size="10">BE Spine 1</text>
                        <rect x="420" y="30" width="80" height="30" rx="4" fill="#059669" stroke="#10b981" stroke-width="2"/>
                        <text x="460" y="50" text-anchor="middle" fill="white" font-size="10">BE Spine 2</text>
                        
                        <!-- Leaf Layer -->
                        <text x="300" y="100" text-anchor="middle" fill="#9ca3af" font-size="12">Leaf Layer (${switches} FE + ${switches} BE switches)</text>
                        <rect x="80" y="110" width="70" height="25" rx="4" fill="#7c3aed" stroke="#8b5cf6"/>
                        <text x="115" y="127" text-anchor="middle" fill="white" font-size="9">FE Leaf 1</text>
                        <rect x="160" y="110" width="70" height="25" rx="4" fill="#7c3aed" stroke="#8b5cf6"/>
                        <text x="195" y="127" text-anchor="middle" fill="white" font-size="9">FE Leaf 2</text>
                        <text x="255" y="127" fill="#6b7280" font-size="10">...</text>
                        
                        <rect x="290" y="110" width="70" height="25" rx="4" fill="#059669" stroke="#10b981"/>
                        <text x="325" y="127" text-anchor="middle" fill="white" font-size="9">BE Leaf 1</text>
                        <rect x="370" y="110" width="70" height="25" rx="4" fill="#059669" stroke="#10b981"/>
                        <text x="405" y="127" text-anchor="middle" fill="white" font-size="9">BE Leaf 2</text>
                        <text x="465" y="127" fill="#6b7280" font-size="10">...</text>
                        
                        <!-- Connection lines spine to leaf -->
                        <line x1="160" y1="60" x2="115" y2="110" stroke="#8b5cf6" stroke-width="1" opacity="0.5"/>
                        <line x1="160" y1="60" x2="195" y2="110" stroke="#8b5cf6" stroke-width="1" opacity="0.5"/>
                        <line x1="260" y1="60" x2="115" y2="110" stroke="#8b5cf6" stroke-width="1" opacity="0.5"/>
                        <line x1="260" y1="60" x2="195" y2="110" stroke="#8b5cf6" stroke-width="1" opacity="0.5"/>
                        <line x1="360" y1="60" x2="325" y2="110" stroke="#10b981" stroke-width="1" opacity="0.5"/>
                        <line x1="360" y1="60" x2="405" y2="110" stroke="#10b981" stroke-width="1" opacity="0.5"/>
                        <line x1="460" y1="60" x2="325" y2="110" stroke="#10b981" stroke-width="1" opacity="0.5"/>
                        <line x1="460" y1="60" x2="405" y2="110" stroke="#10b981" stroke-width="1" opacity="0.5"/>
                        
                        <!-- Server Layer -->
                        <text x="300" y="170" text-anchor="middle" fill="#9ca3af" font-size="12">EBox Servers (${servers} servers × 2 NICs × 2 ports = ${servers * 4} connections)</text>
                        <rect x="100" y="180" width="90" height="35" rx="4" fill="#0891b2" stroke="#22d3ee" stroke-width="2"/>
                        <text x="145" y="195" text-anchor="middle" fill="white" font-size="9">EBox Server 1</text>
                        <text x="145" y="207" text-anchor="middle" fill="#a5f3fc" font-size="8">CX7×2 (4×200G)</text>
                        
                        <rect x="200" y="180" width="90" height="35" rx="4" fill="#0891b2" stroke="#22d3ee" stroke-width="2"/>
                        <text x="245" y="195" text-anchor="middle" fill="white" font-size="9">EBox Server 2</text>
                        <text x="245" y="207" text-anchor="middle" fill="#a5f3fc" font-size="8">CX7×2 (4×200G)</text>
                        
                        <text x="320" y="200" fill="#6b7280" font-size="14">...</text>
                        
                        <rect x="360" y="180" width="90" height="35" rx="4" fill="#0891b2" stroke="#22d3ee" stroke-width="2"/>
                        <text x="405" y="195" text-anchor="middle" fill="white" font-size="9">EBox Server ${servers}</text>
                        <text x="405" y="207" text-anchor="middle" fill="#a5f3fc" font-size="8">CX7×2 (4×200G)</text>
                        
                        <!-- Connection lines leaf to server -->
                        <line x1="115" y1="135" x2="125" y2="180" stroke="#8b5cf6" stroke-width="1" opacity="0.5"/>
                        <line x1="195" y1="135" x2="165" y2="180" stroke="#8b5cf6" stroke-width="1" opacity="0.5"/>
                        <line x1="325" y1="135" x2="125" y2="180" stroke="#10b981" stroke-width="1" opacity="0.5"/>
                        <line x1="405" y1="135" x2="165" y2="180" stroke="#10b981" stroke-width="1" opacity="0.5"/>
                        
                        <!-- Legend -->
                        <rect x="100" y="235" width="12" height="12" rx="2" fill="#7c3aed"/>
                        <text x="118" y="245" fill="#9ca3af" font-size="9">Frontend Network</text>
                        <rect x="230" y="235" width="12" height="12" rx="2" fill="#059669"/>
                        <text x="248" y="245" fill="#9ca3af" font-size="9">Backend Network</text>
                        <rect x="360" y="235" width="12" height="12" rx="2" fill="#0891b2"/>
                        <text x="378" y="245" fill="#9ca3af" font-size="9">EBox Servers</text>
                        
                        <!-- Optics/Speeds -->
                        <text x="300" y="268" text-anchor="middle" fill="#6b7280" font-size="8">Optics: Server→Leaf: ${connectionType === 'breakout' ? '400G (2×200G breakout)' : '200G'} | Leaf→Spine: 400G</text>
                    </svg>
                </div>
            `;
            }
            document.getElementById('network-diagram').innerHTML = diagramHTML;
        }
        
        // Update all visualizations
        function updateVisualizations() {
            const capacity = parseFloat(document.getElementById('capacity').value) || 0;
            const capacityUnit = document.getElementById('capacity-unit').value;
            const capacityType = document.getElementById('capacity-type').value;
            const driveOptionIndex = parseInt(document.getElementById('drive-option').value) || 1;
            
            const capacityInTB = capacityUnit === 'PB' ? capacity * 1000 : capacity;
            const capacityKey = capacityType === 'raw' ? 'raw' : 'usable';
            
            const serversRequired = capacities.map(cap => 
                Math.max(CONFIG.minServers, Math.ceil(capacityInTB / cap[capacityKey] || 0))
            );
            
            // Get selected drive option
            const driveLabels = ['15.3TB', '30.7TB', '61.4TB'];
            const driveColors = ['cyan', 'purple', 'green'];
            const selectedServers = serversRequired[driveOptionIndex];
            const selectedCapacity = capacities[driveOptionIndex];
            
            // Update drive label
            document.getElementById('rack-viz-drive-label').textContent = `(${driveLabels[driveOptionIndex]} drives)`;
            document.getElementById('rack-viz-drive-label').className = `text-sm font-normal text-${driveColors[driveOptionIndex]}-400 ml-2`;
            
            // Generate single rack visualization for selected drive option
            const result = generateRackVisualization(selectedServers, Math.ceil(selectedServers / CONFIG.serversPerRack), 'rack-viz-selected', 'rack-info-selected', driveColors[driveOptionIndex]);
            
            // Update config summary
            const isUnified = selectedNetworkDesign === 'unified';
            const isSplit = selectedRackLayout === 'split';
            const connectionType = document.getElementById('connectionType')?.value || 'direct';
            
            // Check if unified design exceeds single ToR capacity (unified cannot use spine layer)
            const unifiedExceedsToR = isUnified && result.actualRacks > (isSplit ? 2 : 1);
            const unifiedWarning = unifiedExceedsToR ? `
                <div class="mt-3 p-3 bg-red-900/30 border border-red-500/50 rounded-lg">
                    <div class="flex items-start gap-2">
                        <i data-lucide="alert-octagon" class="w-4 h-4 text-red-400 mt-0.5 flex-shrink-0"></i>
                        <div class="text-xs">
                            <div class="text-red-400 font-medium">Unified design not supported at this scale</div>
                            <div class="text-gray-400 mt-1">Unified network design cannot span multiple ToR pairs (no spine layer support). Switch to <strong>Dedicated</strong> network design for clusters requiring ${result.actualRacks} racks.</div>
                        </div>
                    </div>
                </div>
            ` : '';
            
            document.getElementById('rack-config-summary').innerHTML = `
                <div class="flex justify-between"><span class="text-gray-400">Drive Option:</span><span class="text-${driveColors[driveOptionIndex]}-400 font-medium">${driveLabels[driveOptionIndex]}</span></div>
                <div class="flex justify-between"><span class="text-gray-400">Usable per Server:</span><span>${selectedCapacity.usable} TB</span></div>
                <div class="flex justify-between"><span class="text-gray-400">Servers Required:</span><span class="font-medium">${selectedServers}</span></div>
                <div class="flex justify-between"><span class="text-gray-400">Racks Required:</span><span class="font-medium">${result.actualRacks}</span></div>
                <div class="flex justify-between"><span class="text-gray-400">Servers per Rack:</span><span>${result.serversPerRack}</span></div>
                ${isSplit ? `<div class="flex justify-between"><span class="text-gray-400">Servers per Scalable Unit:</span><span>${result.serversPerScalableUnit}</span></div>` : ''}
                <div class="flex justify-between"><span class="text-gray-400">Network Design:</span><span class="${isUnified ? (unifiedExceedsToR ? 'text-red-400' : 'text-yellow-400') : 'text-green-400'}">${isUnified ? 'Unified' : 'Dedicated'}${unifiedExceedsToR ? ' ⚠' : ''}</span></div>
                <div class="flex justify-between"><span class="text-gray-400">Rack Layout:</span><span class="${isSplit ? 'text-purple-400' : 'text-cyan-400'}">${isSplit ? 'Split (2 Racks)' : 'Single Rack'}</span></div>
                <div class="flex justify-between"><span class="text-gray-400">Connection:</span><span>${connectionType === 'breakout' ? '400G→2×200G' : 'Direct 200G'}</span></div>
                <div class="flex justify-between"><span class="text-gray-400">Power per Rack:</span><span>${result.powerPerRack.toFixed(1)} kW</span></div>
                ${unifiedWarning}
            `;
            lucide.createIcons();
            
            // Update deployment scale summary
            const totalUsableCapacity = selectedServers * selectedCapacity.usable;
            const totalLeafSwitches = isUnified ? result.actualRacks : result.actualRacks * 2;
            const scalableUnits = Math.ceil(selectedServers / result.serversPerScalableUnit);
            // Spine switches: 2 for BE (always needed for multi-rack), 2 for FE if dedicated
            // For single ToR pair (unified), no spine needed
            const needsSpine = result.actualRacks > (isSplit ? 2 : 1);
            const beSpineSwitches = needsSpine ? 2 : 0;
            const feSpineSwitches = needsSpine && !isUnified ? 2 : 0;
            const totalSpineSwitches = beSpineSwitches + feSpineSwitches;
            
            document.getElementById('deployment-scale-summary').innerHTML = `
                <div class="p-4 bg-gradient-to-br from-cyan-900/40 to-cyan-900/20 rounded-lg border border-cyan-500/30">
                    <div class="text-3xl font-bold text-cyan-400">${selectedServers}</div>
                    <div class="text-sm text-gray-400">Total Servers</div>
                </div>
                <div class="p-4 bg-gradient-to-br from-purple-900/40 to-purple-900/20 rounded-lg border border-purple-500/30">
                    <div class="text-3xl font-bold text-purple-400">${result.actualRacks}</div>
                    <div class="text-sm text-gray-400">Total Racks</div>
                </div>
                <div class="p-4 bg-gradient-to-br from-green-900/40 to-green-900/20 rounded-lg border border-green-500/30">
                    <div class="text-3xl font-bold text-green-400">${totalLeafSwitches}</div>
                    <div class="text-sm text-gray-400">Leaf Switches</div>
                </div>
                <div class="p-4 bg-gradient-to-br from-orange-900/40 to-orange-900/20 rounded-lg border border-orange-500/30">
                    <div class="text-3xl font-bold text-orange-400">${totalSpineSwitches}</div>
                    <div class="text-sm text-gray-400">Spine Switches</div>
                </div>
                <div class="p-4 bg-gradient-to-br from-yellow-900/40 to-yellow-900/20 rounded-lg border border-yellow-500/30">
                    <div class="text-3xl font-bold text-yellow-400">${(totalUsableCapacity / 1000).toFixed(1)}</div>
                    <div class="text-sm text-gray-400">Usable PB</div>
                </div>
                <div class="col-span-2 md:col-span-5 mt-2 p-3 bg-slate-800/50 rounded-lg text-sm">
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center">
                        <div><span class="text-gray-400">Scalable Units:</span> <span class="font-medium text-cyan-400">${scalableUnits}</span></div>
                        <div><span class="text-gray-400">Racks per Unit:</span> <span class="font-medium">${isSplit ? 2 : 1}</span></div>
                        <div><span class="text-gray-400">Servers per Unit:</span> <span class="font-medium">${result.serversPerScalableUnit}</span></div>
                        <div><span class="text-gray-400">Total Power:</span> <span class="font-medium">${(result.powerPerRack * result.actualRacks).toFixed(0)} kW</span></div>
                        <div><span class="text-gray-400">Spine:</span> <span class="font-medium ${needsSpine ? 'text-orange-400' : 'text-gray-500'}">${needsSpine ? (isUnified ? '⚠ Required' : `${beSpineSwitches} BE + ${feSpineSwitches} FE`) : 'Not needed'}</span></div>
                    </div>
                </div>
            `;
            
            // Port density validation
            const switchType = document.getElementById('switchType')?.value || '32port';
            const switchPorts = switchType === '64port' ? 64 : 32;
            const switchRackUnits = switchType === '64port' ? 2 : 1;
            
            // Calculate port requirements per leaf switch
            // Backend: 5x400G uplinks to each spine (10 total for 2 spines)
            // Frontend: 2x400G uplinks to each spine for redundancy (4 total for 2 spines)
            const beSpineUplinks = 10; // 5 to each of 2 spines
            const feSpineUplinks = 4;  // 2 to each of 2 spines (standard redundancy)
            
            // Server ports per leaf (depends on connection type and split/single)
            // Each server has 2 ports to FE and 2 ports to BE
            // In split design, servers connect to switches in BOTH racks
            const serversPerLeafSwitch = isSplit ? result.serversPerScalableUnit : result.serversPerRack;
            const serverPortsPerSwitch = connectionType === 'breakout' 
                ? serversPerLeafSwitch // 1 port per server (400G breakout to 2x200G)
                : serversPerLeafSwitch * 2; // 2 ports per server (direct 200G)
            
            // Total ports needed per BE leaf
            const bePortsNeeded = serverPortsPerSwitch + beSpineUplinks;
            // Total ports needed per FE leaf  
            const fePortsNeeded = serverPortsPerSwitch + feSpineUplinks;
            
            // Check if ports exceed switch capacity
            const bePortsExceeded = bePortsNeeded > switchPorts;
            const fePortsExceeded = fePortsNeeded > switchPorts;
            
            const portWarningEl = document.getElementById('port-density-warning');
            if (bePortsExceeded || fePortsExceeded) {
                let warningMsg = '<div class="flex items-start gap-2"><i data-lucide="alert-triangle" class="w-4 h-4 text-red-400 mt-0.5 flex-shrink-0"></i><div>';
                warningMsg += '<div class="text-red-400 font-medium">Switch port density exceeded</div>';
                warningMsg += '<div class="text-gray-400 mt-1">';
                if (bePortsExceeded) {
                    warningMsg += `<div>BE Leaf: ${bePortsNeeded} ports needed (${serverPortsPerSwitch} server + ${beSpineUplinks} spine uplinks) > ${switchPorts} available</div>`;
                }
                if (fePortsExceeded) {
                    warningMsg += `<div>FE Leaf: ${fePortsNeeded} ports needed (${serverPortsPerSwitch} server + ${feSpineUplinks} spine uplinks) > ${switchPorts} available</div>`;
                }
                warningMsg += `<div class="mt-1 text-yellow-400">→ ${switchType === '32port' ? 'Switch to 64-port switches or reduce servers per rack' : 'Reduce servers per rack or use split rack design'}</div>`;
                warningMsg += '</div></div></div>';
                portWarningEl.innerHTML = warningMsg;
                portWarningEl.classList.remove('hidden');
                lucide.createIcons();
            } else {
                // Show port utilization info
                portWarningEl.innerHTML = `
                    <div class="text-green-400 text-xs">
                        <div class="font-medium mb-1">✓ Port density OK (${switchPorts}-port ${switchRackUnits}U switches)</div>
                        <div class="grid grid-cols-2 gap-2 text-gray-400">
                            <div>BE Leaf: ${bePortsNeeded}/${switchPorts} ports (${serverPortsPerSwitch} server + ${beSpineUplinks} spine)</div>
                            <div>FE Leaf: ${fePortsNeeded}/${switchPorts} ports (${serverPortsPerSwitch} server + ${feSpineUplinks} spine)</div>
                        </div>
                    </div>
                `;
                portWarningEl.classList.remove('hidden');
            }
            
            // Update power summary
            updatePowerSummary(result);
            
            // Update network diagram using selected drive option
            updateNetworkDiagram(selectedServers, result.actualRacks, result);
        }

        // Add event listeners
        document.getElementById('capacity').addEventListener('input', () => { calculateMetrics(); updateVisualizations(); });
        document.getElementById('capacity-unit').addEventListener('change', () => { calculateMetrics(); updateVisualizations(); });
        document.getElementById('capacity-type').addEventListener('change', () => { calculateMetrics(); updateVisualizations(); });
        document.getElementById('drive-option').addEventListener('change', () => { calculateMetrics(); updateVisualizations(); });
        document.getElementById('rack-power').addEventListener('input', () => { calculateMetrics(); updateVisualizations(); });

        // Initial calculation
        calculateMetrics();
        updateVisualizations();
    </script>
</body>
</html>
